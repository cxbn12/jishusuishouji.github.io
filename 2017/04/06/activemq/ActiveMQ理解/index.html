<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="java,JMS,ActiveMQ," />





  <link rel="alternate" href="/atom.xml" title="技术随手记" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="ActiveMQ理解">
<meta property="og:type" content="article">
<meta property="og:title" content="ActiveMQ理解">
<meta property="og:url" content="http://jishusuishouji.github.io/2017/04/06/activemq/ActiveMQ理解/index.html">
<meta property="og:site_name" content="技术随手记">
<meta property="og:description" content="ActiveMQ理解">
<meta property="og:updated_time" content="2017-04-05T22:12:57.502Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ActiveMQ理解">
<meta name="twitter:description" content="ActiveMQ理解">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jishusuishouji.github.io/2017/04/06/activemq/ActiveMQ理解/"/>





  <title> ActiveMQ理解 | 技术随手记 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">技术随手记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jishusuishouji.github.io/2017/04/06/activemq/ActiveMQ理解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="技术随手记">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="技术随手记">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                ActiveMQ理解
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-06T04:25:34+08:00">
                2017-04-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/JMS/" itemprop="url" rel="index">
                    <span itemprop="name">JMS</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/JMS/ActiveMQ/" itemprop="url" rel="index">
                    <span itemprop="name">ActiveMQ</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/06/activemq/ActiveMQ理解/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2017/04/06/activemq/ActiveMQ理解/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          

          

          

          
              <div class="post-description">
                  ActiveMQ理解
              </div>
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Running-Broker"><a href="#Running-Broker" class="headerlink" title="Running Broker"></a>Running Broker</h2><p>直接运行bin/activemq脚本可以启动一个broker。</p>
<p>此外也可以通过Broker Configuration URI或Broker XBean URI对broker进行配置，以下是一些命令行参数的例子：</p>
<ul>
<li><code>activemq</code> Runs a broker using the default ‘<code>xbean:activemq.xml</code>‘ as the broker configuration file. </li>
<li><code>activemq xbean:myconfig.xml</code> Runs a broker using the file <code>myconfig.xml</code> as the broker configuration file that is located in the classpath. </li>
<li><code>activemq xbean:file:./conf/broker1.xml</code> Runs a broker using the file <code>broker1.xml</code> as the broker configuration file that is located in the relative file path <code>./conf/broker1.xml</code> </li>
<li><code>activemq xbean:file:C:/ActiveMQ/conf/broker2.xml</code> Runs a broker using the file <code>broker2.xml</code> as the broker configuration file that is located in the absolute file path <code>C:/ActiveMQ/conf/broker2.xml</code> </li>
<li><code>activemq broker:(tcp://localhost:61616, tcp://localhost:5000)?useJmx=true</code> Runs a broker with two transport connectors and JMX enabled. </li>
<li><code>activemq broker:(tcp://localhost:61616, network:tcp://localhost:5000)?persistent=false</code> Runs a broker with 1 transport connector and 1 network connector with persistence disabled. </li>
</ul>
<h2 id="Embedded-Broker"><a href="#Embedded-Broker" class="headerlink" title="Embedded Broker"></a>Embedded Broker</h2><p>可以通过在应用程序中以编码的方式启动broker，例如： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">BrokerService broker = new BrokerService(); </div><div class="line">broker.addConnector(&quot;tcp://localhost:61616&quot;); </div><div class="line">broker.start();</div></pre></td></tr></table></figure>
<p>如果需要启动多个broker，那么需要为broker设置一个名字。例如： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">BrokerService broker = new BrokerService(); </div><div class="line">broker.setName(&quot;fred&quot;); </div><div class="line">broker.addConnector(&quot;tcp://localhost:61616&quot;); </div><div class="line">broker.start();</div></pre></td></tr></table></figure>
<p>如果希望在同一个JVM内访问这个broker，那么可以使用VM Transport，URI是：<code>vm://brokerName</code>。 </p>
<h2 id="可以通过BrokerFactory来创建broker，例如："><a href="#可以通过BrokerFactory来创建broker，例如：" class="headerlink" title="可以通过BrokerFactory来创建broker，例如："></a>可以通过<code>BrokerFactory</code>来创建broker，例如：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">BrokerService broker = BrokerFactory.createBroker(new URI(someURI));</div></pre></td></tr></table></figure>
<p><code>someURI</code>的可选值如下： </p>
<table>
<thead>
<tr>
<th style="text-align:center">类型</th>
<th style="text-align:center">示例</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>xbean:</code></td>
<td style="text-align:center"><code>xbean:activemq.xml</code></td>
<td style="text-align:center">Searches the classpath for an XML document with the given URI (<code>activemq.xml</code> in this case) which will then be used as the Xml Configuration</td>
</tr>
<tr>
<td style="text-align:center"><code>file:</code></td>
<td style="text-align:center"><code>file:foo/bar/activemq.xml</code></td>
<td style="text-align:center">Loads the given file (in this example <code>foo/bar/activemq.xml</code>) as the Xml Configuration</td>
</tr>
<tr>
<td style="text-align:center"><code>broker:</code></td>
<td style="text-align:center"><code>broker:tcp://localhost:61616</code></td>
<td style="text-align:center">Uses the Broker Configuration URI to configure the broker</td>
</tr>
</tbody>
</table>
<p>当使用<code>XBean</code>的配置方式的时候，需要指定一个xml配置文件，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">BrokerService broker = BrokerFactory.createBroker(new URI(&quot;xbean:com/test/activemq.xml&quot;));</div></pre></td></tr></table></figure></p>
<p>使用Spring的配置方式如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;broker&quot; class=&quot;org.apache.activemq.xbean.BrokerFactoryBean&quot;&gt; </div><div class="line">   &lt;property name=&quot;config&quot; value=&quot;classpath:org/apache/activemq/xbean/activemq.xml&quot; /&gt; </div><div class="line">   &lt;property name=&quot;start&quot; value=&quot;true&quot; /&gt; </div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>
<h2 id="Monitoring-Broker"><a href="#Monitoring-Broker" class="headerlink" title="Monitoring Broker"></a>Monitoring Broker</h2><h3 id="JMX"><a href="#JMX" class="headerlink" title="JMX"></a>JMX</h3><p>在使用JMX监控broker之前，首先要启用broker的JMX监控功能，例如在配置文件中设置<code>useJmx=&quot;true&quot;</code>，如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;broker useJmx=&quot;true&quot; brokerName=&quot;broker1&gt; </div><div class="line">    &lt;managementContext&gt; </div><div class="line">         &lt;managementContext createConnector=&quot;true&quot;/&gt; </div><div class="line">    &lt;/managementContext&gt; </div><div class="line"> ... </div><div class="line">&lt;/broker&gt;</div></pre></td></tr></table></figure>
<p>接下来运行JDK自带的jconsole。在运行了jconsole后，它会弹出对话框来选择需要连接到的<code>agent</code>。如果是在启动broker的主机上运行jconsole，那么ActiveMQ broker会出现在jconsole的Local标签中。如果要连接到远程的broker，那么可以在Advanced标签中指定JMX URL，以下是一个连接到本机的JMX URL：<br><code>service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi</code><br>在jconsole的MBeans标签中，可以查看详细信息，也可以执行相应的operation。需要注意的是，在jconsole连接到broker的时候，并不需要输入用户名和密码，如果这存在潜在的安全问题，那么就需要为JMX Connector配置密码保护（需要使用1.5以上版本的JDK）。 </p>
<p>首先要禁止ActiveMQ创建自己的connector，例如： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;broker xmlns=&quot;http://activemq.org/config/1.0&quot; brokerName=&quot;localhost&quot;useJmx=&quot;true&quot;&gt; </div><div class="line">    &lt;managementContext&gt; </div><div class="line">        &lt;managementContext createConnector=&quot;false&quot;/&gt; </div><div class="line">    &lt;/managementContext&gt; </div><div class="line">&lt;/broker&gt;</div></pre></td></tr></table></figure>
<p>然后在ActiveMQ的<code>conf</code>目录下创建一个访问控制文件和密码文件，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">conf/jmx.access： </div><div class="line"># The &quot;monitorRole&quot; role has readonly access. </div><div class="line"># The &quot;controlRole&quot; role has readwrite access. </div><div class="line">monitorRole readonly </div><div class="line">controlRole readwrite</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">conf/jmx.password： </div><div class="line"># The &quot;monitorRole&quot; role has password &quot;abc123&quot;. </div><div class="line"># The &quot;controlRole&quot; role has password &quot;abcd1234&quot;. </div><div class="line">monitorRole abc123 </div><div class="line">controlRole abcd1234</div></pre></td></tr></table></figure>
<p>然后修改ActiveMQ的bin目录下activemq的启动脚本，查找包含”<code>SUNJMX=</code>“的一行如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">REM set SUNJMX=-Dcom.sun.management.jmxremote.port=1616 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</div></pre></td></tr></table></figure>
<p>把它替换成 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set SUNJMX=-Dcom.sun.management.jmxremote.port=1616 -Dcom.sun.management.jmxremote.authenticate=true -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.password.file=%ACTIVEMQ_BASE%/conf/jmx.password -Dcom.sun.management.jmxremote.access.file=%ACTIVEMQ_BASE%/conf/jmx.access</div></pre></td></tr></table></figure>
<p>最后重启ActiveMQ和jconsole，这时候需要强制login。如果在启动activemq的过程中出现以下错误，那么需要为这个文件增加访问控制。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Error: Password file read access must be restricted: D:\apache-activemq-5.0.0\bin\../conf/jmx.password</div></pre></td></tr></table></figure></p>
<h3 id="Web-Console"><a href="#Web-Console" class="headerlink" title="Web Console"></a>Web Console</h3><p>Web Console被集成到了ActiveMQ的二进制发布包中，因此缺省访问<code>http://localhost:8161/admin</code>即可访问Web Console。<br>在配置文件中，可以通过修改<code>nioConnector</code>的<code>port</code>属性来修改Web console的缺省端口： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;jetty xmlns=&quot;http://mortbay.com/schemas/jetty/1.0&quot;&gt; </div><div class="line">        &lt;connectors&gt; </div><div class="line">                &lt;nioConnector port=&quot;8161&quot; /&gt; </div><div class="line">        &lt;/connectors&gt; </div><div class="line">        ... </div><div class="line">&lt;/jetty&gt;</div></pre></td></tr></table></figure>
<p>出于安全性或者可靠性的考虑，Web Console可以被部署到不同于ActiveMQ的进程中。例如把<code>activemq-web-console.war</code>部署到一个单独的web容器中（Tomcat，Jetty等）。在ActiveMQ5.0的二进制发布包中不包含<code>activemq-web-console.war</code>，因此需要下载 ActiveMQ的源码，然后进入到<code>${activemq.base}/src/activemq-web-console</code>目录中执行<code>mvn instanll</code>。如果一切正常，那么缺省会在<code>${activemq.base}/src/activemq-web-console/target</code>目录中生成<code>activemq-web-console-5.0.0.war</code>。然后将<code>activemq-web-console-5.0.0.war</code>拷贝到Tomcat的<code>webapps</code>目录中，并重命名成<code>activemq-web-console.war</code>。<br>需要注意的是，要将<code>activemq-all-5.0.0.jar</code>拷贝到<code>WEB-INF\lib</code>目录中（可能还需要拷贝<code>jms.jar</code>）。还要为Tomcat设置以下五个系统属性（修改<code>catalina.bat</code>文件）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">set JAVA_OPTS=%JAVA_OPTS% -Dwebconsole.type=&quot;properties&quot; </div><div class="line">set JAVA_OPTS=%JAVA_OPTS% -Dwebconsole.jms.url=&quot;tcp://localhost:61616&quot; </div><div class="line">set JAVA_OPTS=%JAVA_OPTS% -Dwebconsole.jmx.url=&quot;service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi&quot; </div><div class="line">set JAVA_OPTS=%JAVA_OPTS% -Dwebconsole.jmx.role=&quot;&quot; </div><div class="line">set JAVA_OPTS=%JAVA_OPTS% -Dwebconsole.jmx.password=&quot;&quot;</div></pre></td></tr></table></figure></p>
<p>如果JMX没有配置密码保护，那么<code>webconsole.jmx.role</code>和<code>webconsole.jmx.password</code>设置成<code>&quot;&quot;</code>即可。如果broker被配置成了Master/Slave模式，那么可以配置成使用failover transport，例如： </p>
<pre><code>-Dwebconsole.jms.url=failover:(tcp://serverA:61616,tcp://serverB:61616)
</code></pre><p>顺便说一下，由于<code>webconsole.type</code>属性是<code>properties</code>，因此实际上起作用的Web Console的配置文件是<code>WEB-INF/webconsole-properties.xml</code>。最后启动被监控的ActiveMQ，访问<code>http://localhost:8080 /activemq-web-console/</code>，查看显示是否正常。 </p>
<h3 id="Advisory-Message"><a href="#Advisory-Message" class="headerlink" title="Advisory Message"></a>Advisory Message</h3><p>ActiveMQ支持Advisory Messages，它允许你通过标准的JMS消息来监控系统。目前的Advisory Messages支持：<br>• consumers, producers and connections starting and stopping<br>• temporary destinations being created and destroyed<br>• messages expiring on topics and queues<br>• brokers sending messages to destinations with no consumers.<br>• connections starting and stopping </p>
<p>Advisory Messages可以被想象成某种的管理通道，通过它你可以得到关于JMS provider、producers、consumers和destinations的信息。Advisory topics都使用<code>ActiveMQ.Advisory.</code>这个前缀，以下是目前支持的topics： </p>
<p>Client based advisories<br>Advisory Topics Description<br>ActiveMQ.Advisory.Connection Connection start &amp; stop messages<br>ActiveMQ.Advisory.Producer.Queue Producer start &amp; stop messages on a Queue<br>ActiveMQ.Advisory.Producer.Topic Producer start &amp; stop messages on a Topic<br>ActiveMQ.Advisory.Consumer.Queue Consumer start &amp; stop messages on a Queue<br>ActiveMQ.Advisory.Consumer.Topic Consumer start &amp; stop messages on a Topic </p>
<p>在消费者启动/停止的Advisory Messages的消息头中有个<code>consumerCount</code>属性，它用来指明目前desination上活跃的consumer的数量。<br>Destination and Message based advisories<br>Advisory Topics Description<br>ActiveMQ.Advisory.Queue Queue create &amp; destroy<br>ActiveMQ.Advisory.Topic Topic create &amp; destroy<br>ActiveMQ.Advisory.TempQueue Temporary Queue create &amp; destroy<br>ActiveMQ.Advisory.TempTopic Temporary Topic create &amp; destroy<br>ActiveMQ.Advisory.Expired.Queue Expired messages on a Queue<br>ActiveMQ.Advisory.Expired.Topic Expired messages on a Topic<br>ActiveMQ.Advisory.NoConsumer.Queue No consumer is available to process messages being sent on a Queue<br>ActiveMQ.Advisory.NoConsumer.Topic No consumer is available to process messages being sent on a Topic </p>
<p>以上的这些destnations都可以用来作为前缀，在其后面追加其它的重要信息，例如topic、queue、clientID、 producderID和consumerID等。这令你可以利用Wildcards和Selectors来过滤Advisory Messages。<br>例如，如果你希望订阅<code>FOO.BAR</code>这个queue上Consumer的start/stop的消息，那么可以订阅<code>ActiveMQ.Advisory.Consumer.Queue.FOO.BAR</code>；如果希望订阅所有queue上的start/stop消息，那么可以订阅<code>ActiveMQ.Advisory.Consumer.Queue.</code>；如果希望订阅所有queue或者topic上的start/stop消息，那么可以订阅<code>ActiveMQ.Advisory.Consumer.</code>。<br><code>org.apache.activemq.advisory.AdvisorySupport</code>类上有如下的helper methods，用来在程序中得到advisory destination objects。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">AdvisorySupport.getConsumerAdvisoryTopic() </div><div class="line">AdvisorySupport.getProducerAdvisoryTopic() </div><div class="line">AdvisorySupport.getDestinationAdvisoryTopic() </div><div class="line">AdvisorySupport.getExpiredTopicMessageAdvisoryTopic() </div><div class="line">AdvisorySupport.getExpiredQueueMessageAdvisoryTopic() </div><div class="line">AdvisorySupport.getNoTopicConsumersAdvisoryTopic() </div><div class="line">AdvisorySupport.getNoQueueConsumersAdvisoryTopic()</div></pre></td></tr></table></figure></p>
<p>以下是段使用Advisory Messages的程序代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Destination advisoryDestination = AdvisorySupport.getProducerAdvisoryTopic(destination) </div><div class="line">MessageConsumer consumer = session.createConsumer(advisoryDestination); </div><div class="line">consumer.setMessageListener(this); </div><div class="line">... </div><div class="line">public void onMessage(Message msg)&#123; </div><div class="line">        if (msg instanceof ActiveMQMessage)&#123; </div><div class="line">                try &#123; </div><div class="line">                        ActiveMQMessage aMsg = (ActiveMQMessage)msg; </div><div class="line">                        ProducerInfo prod = (ProducerInfo) aMsg.getDataStructure(); </div><div class="line">                &#125; catch (JMSException e) &#123; </div><div class="line">                        log.error(&quot;Failed to process message: &quot; + msg); </div><div class="line">                &#125; </div><div class="line">        &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Command-Agent"><a href="#Command-Agent" class="headerlink" title="Command Agent"></a>Command Agent</h3><p>在介绍Command Agent前首先简要介绍一下XMPP(Jabber)协议，XMPP是一种基于XML的即时通信协议，它由Jabber软件基金会开发。在配置文件中通过增加<code>transportConnector</code>来支持XMPP协议：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;broker xmlns=&quot;http://activemq.org/config/1.0&quot;&gt; </div><div class="line">        &lt;transportConnectors&gt; </div><div class="line">        ... </div><div class="line">                &lt;transportConnector name=&quot;xmpp&quot; uri=&quot;xmpp://localhost:61222&quot;/&gt; </div><div class="line">        &lt;/transportConnectors&gt; </div><div class="line">&lt;/broker&gt;</div></pre></td></tr></table></figure></p>
<p>ActiveMQ提供了ActiveMQ messages和XMPP之间的双向桥接：<br>• 如果客户加入了一个聊天室，那么这个聊天室的名字会被映射到一个JMS topic。<br>• 尝试在聊天室内发送消息会导致一个JMS消息被发送到这个topic。<br>• 呆在一个聊天室中意味着这将保持一个对相应JMS topic的订阅。因此发送到这个topic的JMS消息也会被发送到聊天室。</p>
<p>从4.2版本起，ActiveMQ支持<code>Command Agent</code>。在配置文件中，通过设置<code>commandAgent</code>来启用Command Agent： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;beans&gt; </div><div class="line">        &lt;broker useJmx=&quot;true&quot; xmlns=&quot;http://activemq.org/config/1.0&quot;&gt; </div><div class="line">        ... </div><div class="line">        &lt;/broker&gt; </div><div class="line">        &lt;commandAgent xmlns=&quot;http://activemq.org/config/1.0&quot;/&gt; </div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
<p>启用了Command Agent的broker上会有一个来自Command Agent的连接，它同时订阅topic：<code>ActiveMQ.Agent</code>。在你启动XMPP客户端，加入到<code>ActiveMQ.Agent</code>聊天室后，就可以同broker进行交谈了。通过在XMPP客户端中键入help，可以得到帮助信息。<br>需要注意的是，ActiveMQ5.0版本有个小bug，如果broker没有采用缺省的用户名和密码，那么Command Agent便无法正常启动。Apache官方文档说，此bug已经被修正，预定在5.2.0版本上体现。修改方式如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;commandAgent xmlns=&quot;http://activemq.org/config/1.0&quot; brokerUser=&quot;user&quot; brokerPassword=&quot;passward&quot;/&gt;</div></pre></td></tr></table></figure></p>
<h3 id="Visualization-plugin"><a href="#Visualization-plugin" class="headerlink" title="Visualization plugin"></a>Visualization plugin</h3><p>ActiveMQ支持以broker插件的形式生成DOT文件(可以用agrviewer来查看)，以图表的方式描述connections、sessions、producers、consumers、destinations等信息。配置方式如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;broker xmlns=&quot;http://activemq.org/config/1.0&quot; brokerName=&quot;localhost&quot; useJmx=&quot;true&quot;&gt; </div><div class="line">        ... </div><div class="line">    &lt;plugins&gt; </div><div class="line">        &lt;connectionDotFilePlugin file=&quot;connection.dot&quot;/&gt; </div><div class="line">        &lt;destinationDotFilePlugin file=&quot;destination.dot&quot;/&gt; </div><div class="line">        &lt;/plugins&gt; </div><div class="line">&lt;/broker&gt;</div></pre></td></tr></table></figure></p>
<p>需要注意的是，笔者认为ActiveMQ5.0版本的Visualization Plugin尚不稳定，存在诸多问题。例如：如果使用<code>connectionDotFilePlugin</code>，那么<code>brokerName</code>必须是<code>localhost</code>；如果使用<code>destinationDotFilePlugin</code>可能会导致<code>ArrayStoreException</code>。 </p>
<h2 id="Transport"><a href="#Transport" class="headerlink" title="Transport"></a>Transport</h2><p>ActiveMQ目前支持的transport有：VM Transport、TCP Transport、SSL Transport、Peer Transport、UDP Transport、Multicast Transport、HTTP and HTTPS Transport、Failover Transport、Fanout Transport、Discovery Transport、ZeroConf Transport等。</p>
<h3 id="VM-Transport"><a href="#VM-Transport" class="headerlink" title="VM Transport"></a>VM Transport</h3><p>VM transport允许在VM内部通信，从而避免了网络传输的开销。这时候采用的连接不是socket连接，而是直接地方法调用。 第一个创建VM连接的客户会启动一个embed VM broker，接下来所有使用相同的broker name的VM连接都会使用这个broker。当这个broker上所有的连接都关闭的时候，这个broker也会自动关闭。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vm://brokerName?transportOptions</div></pre></td></tr></table></figure>
<p>例如：<code>vm://broker1?marshal=false&amp;broker.persistent=false</code><br>Transport Options的可选值如下： </p>
<table>
<thead>
<tr>
<th style="text-align:center">Option Name</th>
<th style="text-align:center">Default Value</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Marshal</td>
<td style="text-align:center">false</td>
<td style="text-align:center">If true, forces each command sent over the transport to be marshlled and unmarshlled using a WireFormat</td>
</tr>
<tr>
<td style="text-align:center">wireFormat</td>
<td style="text-align:center">default</td>
<td style="text-align:center">The name of the WireFormat to use </td>
</tr>
</tbody>
</table>
<p>wireFormat.<em> All the properties with this prefix are used to configure the wireFormat |<br>| create |  true |  If the broker should be created on demand if it does not allready exist. Only supported in ActiveMQ 4.1 |<br>| broker.</em>  | All  | the properties with this prefix are used to configure the broker. See Configuring Wire Formats for more information  | </p>
<p>以下是高级配置语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vm:(broker:(tcp://localhost)?brokerOptions)?transportOptions </div><div class="line">vm:broker:(tcp://localhost)?brokerOptions</div></pre></td></tr></table></figure></p>
<p>例如：<code>vm:(broker:(tcp://localhost:6000)?persistent=false)?marshal=false</code> </p>
<p>使用配置文件的配置语法：<br><code>vm://localhost?brokerConfig=xbean:activemq.xml</code><br>例如：<code>vm:// localhost?brokerConfig=xbean:com/test/activemq.xml</code></p>
<p>使用Spring的配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;broker&quot; class=&quot;org.apache.activemq.xbean.BrokerFactoryBean&quot;&gt; </div><div class="line">        &lt;property name=&quot;config&quot; value=&quot;classpath:org/apache/activemq/xbean/activemq.xml&quot; /&gt; </div><div class="line">        &lt;property name=&quot;start&quot; value=&quot;true&quot; /&gt; </div><div class="line">        &lt;/bean&gt; </div><div class="line"></div><div class="line">&lt;bean id=&quot;connectionFactory&quot; class=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot; depends-on=&quot;broker&quot;&gt; </div><div class="line">&lt;property name=&quot;brokerURL&quot; value=&quot;vm://localhost&quot;/&gt; </div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>
<p>如果<code>persistent</code>是<code>true</code>，那么ActiveMQ会在当前目录下创建一个缺省值是<code>activemq-data</code>的目录用于持久化保存数据。需要注意的是，如果程序中启动了多个不同名字的VM broker，那么可能会有如下警告：<code>Failed to start jmx connector: Cannot bind to URL [rmi://localhost:1099/jmxrmi]:javax.naming.NameAlreadyBoundException…</code>可以通过在<code>transportOptions</code>中追加<code>broker.useJmx=false</code>来禁用JMX来避免这个警告。 </p>
<h3 id="TCP-Transport"><a href="#TCP-Transport" class="headerlink" title="TCP Transport"></a>TCP Transport</h3><p>TCP transport 允许客户端通过TCP socket连接到远程的broker。以下是配置语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tcp://hostname:port?transportOptions</div></pre></td></tr></table></figure></p>
<p>Transport Options的可选值如下： </p>
<table>
<thead>
<tr>
<th style="text-align:center">Option Name</th>
<th style="text-align:center">Default Value</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">minmumWireFormatVersion</td>
<td style="text-align:center">0</td>
<td style="text-align:center">The minimum version wireformat that is allowed</td>
</tr>
<tr>
<td style="text-align:center">trace</td>
<td style="text-align:center">false</td>
<td style="text-align:center">Causes all commands that are sent over the transport to be logged</td>
</tr>
<tr>
<td style="text-align:center">useLocalHost</td>
<td style="text-align:center">true</td>
<td style="text-align:center">When true, it causes the local machines name to resolve to “localhost”.</td>
</tr>
<tr>
<td style="text-align:center">socketBufferSize</td>
<td style="text-align:center">64 * 1024</td>
<td style="text-align:center">Sets the socket buffer size in bytes </td>
</tr>
</tbody>
</table>
<p>soTimeout 0 sets the socket timeout in milliseconds |<br>| connectionTimeout | 30000 | A non-zero value specifies the connection timeout in milliseconds. A zero value means wait forever for the connection to be established. Negative values are ignored. |<br>| wireFormat | default | The name of the WireFormat to use wireFormat.* All the properties with this prefix are used to configure the wireFormat. See Configuring Wire Formats for more information  | </p>
<p>例如：<code>tcp://localhost:61616?trace=false</code> </p>
<h3 id="Failover-Transport"><a href="#Failover-Transport" class="headerlink" title="Failover Transport"></a>Failover Transport</h3><p>Failover Transport是一种重新连接的机制，它工作于其它transport的上层，用于建立可靠的传输。它的配置语法允许制定任意多个复合的URI。Failover transport会自动选择其中的一个URI来尝试建立连接。如果没有成功，那么会选择一个其它的URI来建立一个新的连接。以下是配置语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">failover:(uri1,...,uriN)?transportOptions </div><div class="line">failover:uri1,...,uriN</div></pre></td></tr></table></figure></p>
<p>Transport Options的可选值如下： </p>
<table>
<thead>
<tr>
<th style="text-align:center">Option Name</th>
<th style="text-align:center">Default Value</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">initialReconnectDelay</td>
<td style="text-align:center">10</td>
<td style="text-align:center">How long to wait before the first reconnect attempt (in ms)</td>
</tr>
<tr>
<td style="text-align:center">maxReconnectDelay</td>
<td style="text-align:center">30000</td>
<td style="text-align:center">The maximum amount of time we ever wait between reconnect attempts (in ms)</td>
</tr>
<tr>
<td style="text-align:center">useExponentialBackOff</td>
<td style="text-align:center">true</td>
<td style="text-align:center">Should an exponential backoff be used between reconnect attempts</td>
</tr>
<tr>
<td style="text-align:center">backOffMultiplier</td>
<td style="text-align:center">2</td>
<td style="text-align:center">The exponent used in the exponential backoff attempts</td>
</tr>
<tr>
<td style="text-align:center">maxReconnectAttempts</td>
<td style="text-align:center">0</td>
<td style="text-align:center">If not 0, then this is the maximum number of reconnect attempts before an error is sent back to the client</td>
</tr>
<tr>
<td style="text-align:center">randomize</td>
<td style="text-align:center">true</td>
<td style="text-align:center">use a random algorithm to choose the URI to use for reconnect from the list provided</td>
</tr>
<tr>
<td style="text-align:center">backup</td>
<td style="text-align:center">false</td>
<td style="text-align:center">initialize and hold a second transport connection - to enable fast failover</td>
</tr>
</tbody>
</table>
<p>例如：<code>failover:(tcp://localhost:61616,tcp://remotehost:61616)?initialReconnectDelay=100</code></p>
<h3 id="Discovery-transport"><a href="#Discovery-transport" class="headerlink" title="Discovery transport"></a>Discovery transport</h3><p>Discovery transport是可靠的tranport。它使用Discovery transport来定位用来连接的URI列表。以下是配置语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">discovery:(discoveryAgentURI)?transportOptions </div><div class="line">discovery:discoveryAgentURI</div></pre></td></tr></table></figure></p>
<p>Transport Options的可选值如下： </p>
<table>
<thead>
<tr>
<th style="text-align:center">Option Name</th>
<th style="text-align:center">Default Value</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">initialReconnectDelay</td>
<td style="text-align:center">10</td>
<td style="text-align:center">How long to wait before the first reconnect attempt</td>
</tr>
<tr>
<td style="text-align:center">maxReconnectDelay</td>
<td style="text-align:center">30000</td>
<td style="text-align:center">The maximum amount of time we ever wait between reconnect attempts</td>
</tr>
<tr>
<td style="text-align:center">useExponentialBackOff</td>
<td style="text-align:center">true</td>
<td style="text-align:center">Should an exponential backoff be used btween reconnect attempts</td>
</tr>
<tr>
<td style="text-align:center">backOffMultiplier</td>
<td style="text-align:center">2</td>
<td style="text-align:center">The exponent used in the exponential backoff attempts</td>
</tr>
<tr>
<td style="text-align:center">maxReconnectAttempts</td>
<td style="text-align:center">0</td>
<td style="text-align:center">If not 0, then this is the maximum number of reconnect attempts before an error is sent back to the client</td>
</tr>
</tbody>
</table>
<p>例如：<code>discovery:(multicast://default)?initialReconnectDelay=100</code><br>为了使用Discovery来发现broker，需要为broker启用discovery agent。 以下是XML配置文件中的一个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;broker name=&quot;foo&quot;&gt; </div><div class="line">        &lt;transportConnectors&gt; </div><div class="line">                &lt;transportConnector uri=&quot;tcp://localhost:0&quot; discoveryUri=&quot;multicast://default&quot;/&gt; </div><div class="line">        &lt;/transportConnectors&gt; </div><div class="line">... </div><div class="line">&lt;/broker&gt;</div></pre></td></tr></table></figure></p>
<p>在使用Failover Transport或Discovery transport等能够自动重连的transport的时候，需要注意的是：设想有两个broker，它们都启用AMQ Message Store作为持久化存储，有一个producer和一个consumer连接到某个queue。当因其中一个broker失效时而切换到另一个 broker的时候，如果失效的broker的queue中还有未被consumer消费的消息，那么这个queue里的消息仍然滞留在失效broker 的中，直到失效的broker被修复并重新切换回这个被修复的broker后，之前被保留的消息才会被consumer消费掉。如果被处理的消息有时序限制，那么应用程序就需要处理这个问题。另外也可以通过ActiveMQ集群来解决这个问题。<br>在transport重连的时候，可以在connection上注册<code>TransportListener</code>来获得回调，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">(ActiveMQConnection)connection).addTransportListener(new TransportListener() &#123; </div><div class="line">public void onCommand(Object cmd) &#123; </div><div class="line">&#125; </div><div class="line"></div><div class="line">public void onException(IOException exp) &#123; </div><div class="line">&#125; </div><div class="line"></div><div class="line">public void transportInterupted() &#123; </div><div class="line">// The transport has suffered an interruption from which it hopes to recover. </div><div class="line">&#125; </div><div class="line"> </div><div class="line">public void transportResumed() &#123; </div><div class="line">// The transport has resumed after an interruption. </div><div class="line">&#125; </div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h2><h3 id="AMQ-Message-Store"><a href="#AMQ-Message-Store" class="headerlink" title="AMQ Message Store"></a>AMQ Message Store</h3><p>AMQ Message Store是ActiveMQ5.0缺省的持久化存储。Message commands被保存到transactional journal（由rolling data logs组成）。Messages被保存到data logs中，同时被reference store进行索引以提高存取速度。Date logs由一些单独的data log文件组成，缺省的文件大小是32M，如果某个消息的大小超过了data log文件的大小，那么可以修改配置以增加data log文件的大小。如果某个data log文件中所有的消息都被成功消费了，那么这个data log文件将会被标记，以便在下一轮的清理中被删除或者归档。以下是其配置的一个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;broker brokerName=&quot;broker&quot; persistent=&quot;true&quot; useShutdownHook=&quot;false&quot;&gt; </div><div class="line">        &lt;persistenceAdapter&gt; </div><div class="line">                &lt;amqPersistenceAdapter directory=&quot;$&#123;activemq.base&#125;/data&quot; maxFileLength=&quot;32mb&quot;/&gt; </div><div class="line">        &lt;/persistenceAdapter&gt; </div><div class="line">&lt;/broker&gt;</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th style="text-align:center">Property name</th>
<th style="text-align:center">Default value</th>
<th style="text-align:center">Comments</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">directory</td>
<td style="text-align:center">activemq-data</td>
<td style="text-align:center">the path to the directory to use to store the message store data and log files</td>
</tr>
<tr>
<td style="text-align:center">useNIO</td>
<td style="text-align:center">true</td>
<td style="text-align:center">use NIO to write messages to the data logs</td>
</tr>
<tr>
<td style="text-align:center">syncOnWrite</td>
<td style="text-align:center">false</td>
<td style="text-align:center">sync every write to disk</td>
</tr>
<tr>
<td style="text-align:center">maxFileLength</td>
<td style="text-align:center">32mb</td>
<td style="text-align:center">a hint to set the maximum size of the message data logs</td>
</tr>
<tr>
<td style="text-align:center">persistentIndex</td>
<td style="text-align:center">true</td>
<td style="text-align:center">use a persistent index for the message logs. If this is false, an in-memory structure is maintained</td>
</tr>
<tr>
<td style="text-align:center">maxCheckpointMessageAddSize</td>
<td style="text-align:center">4kb</td>
<td style="text-align:center">the maximum number of messages to keep in a transaction before automatically committing</td>
</tr>
<tr>
<td style="text-align:center">cleanupInterval</td>
<td style="text-align:center">30000</td>
<td style="text-align:center">time (ms) before checking for a discarding/moving message data logs that are no longer used</td>
</tr>
<tr>
<td style="text-align:center">indexBinSize</td>
<td style="text-align:center">1024</td>
<td style="text-align:center">default number of bins used by the index. The bigger the bin size - the better the relative performance of the index</td>
</tr>
<tr>
<td style="text-align:center">indexKeySize</td>
<td style="text-align:center">96</td>
<td style="text-align:center">the size of the index key - the key is the message id </td>
</tr>
</tbody>
</table>
<p>indexPageSize 16kb the size of the index page - the bigger the page - the better the write performance of the index  |<br>| directoryArchive | archive | the path to the directory to use to store discarded data logs |<br>| archiveDataLogs | false | if true data logs are moved to the archive directory instead of being deleted | </p>
<h3 id="Kaha-Persistence"><a href="#Kaha-Persistence" class="headerlink" title="Kaha Persistence"></a>Kaha Persistence</h3><p>Kaha Persistence 是一个专门针对消息持久化的解决方案。它对典型的消息使用模式进行了优化。在Kaha中，数据被追加到data logs中。当不再需要log文件中的数据的时候，log文件会被丢弃。以下是其配置的一个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;broker brokerName=&quot;broker&quot; persistent=&quot;true&quot; useShutdownHook=&quot;false&quot;&gt; </div><div class="line">        &lt;persistenceAdapter&gt; </div><div class="line">                &lt;kahaPersistenceAdapter directory=&quot;activemq-data&quot;       maxDataFileLength=&quot;33554432&quot;/&gt; </div><div class="line">        &lt;/persistenceAdapter&gt; </div><div class="line">&lt;/broker&gt;</div></pre></td></tr></table></figure></p>
<h3 id="JDBC-Persistence"><a href="#JDBC-Persistence" class="headerlink" title="JDBC Persistence"></a>JDBC Persistence</h3><p>目前支持的数据库有Apache Derby, Axion, DB2, HSQL, Informix, MaxDB, MySQL, Oracle, Postgresql, SQLServer, Sybase。<br>如果你使用的数据库不被支持，那么可以调整<code>StatementProvider</code>来保证使用正确的SQL方言（flavour of SQL）。通常绝大多数数据库支持以下adaptor：<br>• org.activemq.store.jdbc.adapter.BlobJDBCAdapter<br>• org.activemq.store.jdbc.adapter.BytesJDBCAdapter<br>• org.activemq.store.jdbc.adapter.DefaultJDBCAdapter<br>• org.activemq.store.jdbc.adapter.ImageJDBCAdapter</p>
<p>也可以在配置文件中直接指定JDBC adaptor，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;jdbcPersistenceAdapter adapterClass=&quot;org.apache.activemq.store.jdbc.adapter.ImageBasedJDBCAdaptor&quot;/&gt;</div></pre></td></tr></table></figure></p>
<p>以下是其配置的一个例子： </p>
<pre><code>&lt;persistence&gt; 
     &lt;jdbcPersistence dataSourceRef=&quot; mysql-ds&quot;/&gt; 
&lt;/persistence&gt; 

&lt;bean id=&quot;mysql-ds&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt; 
     &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt; 
     &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost/activemq?relaxAutoCommit=true&quot;/&gt; 
     &lt;property name=&quot;username&quot; value=&quot;activemq&quot;/&gt; 
     &lt;property name=&quot;password&quot; value=&quot;activemq&quot;/&gt; 
     &lt;property name=&quot;poolPreparedStatements&quot; value=&quot;true&quot;/&gt; 
&lt;/bean&gt; 
</code></pre><p>需要注意的是，如果使用MySQL，那么需要设置<code>relaxAutoCommit</code>标志为<code>true</code>。 </p>
<h3 id="Disable-Persistence"><a href="#Disable-Persistence" class="headerlink" title="Disable Persistence"></a>Disable Persistence</h3><p>以下是其配置的一个例子： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;broker persistent=&quot;false&quot;&gt;&lt;/broker&gt;</div></pre></td></tr></table></figure>
<h2 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h2><p>ActiveMQ支持可插拔的安全机制，用以在不同的provider之间切换。 </p>
<h3 id="Simple-Authentication-Plugin"><a href="#Simple-Authentication-Plugin" class="headerlink" title="Simple Authentication Plugin"></a>Simple Authentication Plugin</h3><p>Simple Authentication Plugin适用于简单的认证需求，或者用于建立测试环境。它允许在XML配置文件中指定用户、用户组和密码等信息。以下是ActiveMQ配置的一个例子： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;plugins&gt; </div><div class="line">        ... </div><div class="line">        &lt;simpleAuthenticationPlugin&gt; </div><div class="line">                &lt;users&gt; </div><div class="line">                     &lt;authenticationUser username=&quot;system&quot; password=&quot;manager&quot;   groups=&quot;users,admins&quot;/&gt; </div><div class="line">                     &lt;authenticationUser username=&quot;user&quot; password=&quot;password&quot; groups=&quot;users&quot;/&gt; </div><div class="line">                     &lt;authenticationUser username=&quot;guest&quot; password=&quot;password&quot; groups=&quot;guests&quot;/&gt; </div><div class="line">                &lt;/users&gt; </div><div class="line">        &lt;/simpleAuthenticationPlugin&gt; </div><div class="line">&lt;/plugins&gt;</div></pre></td></tr></table></figure>
<h3 id="JAAS-Authentication-Plugin"><a href="#JAAS-Authentication-Plugin" class="headerlink" title="JAAS Authentication Plugin"></a>JAAS Authentication Plugin</h3><p>JAAS Authentication Plugin依赖标准的JAAS机制来实现认证。通常情况下，你需要通过设置<code>java.security.auth.login.config</code>系统属性来配置login modules的配置文件。如果没有指定这个系统属性，那么JAAS Authentication Plugin会缺省使用<code>login.config</code>作为文件名。以下是一个<code>login.config</code>文件的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">activemq-domain &#123; </div><div class="line">        org.apache.activemq.jaas.PropertiesLoginModule required debug=true org.apache.activemq.jaas.properties.user=&quot;users.properties&quot; org.apache.activemq.jaas.properties.group=&quot;groups.properties&quot;; </div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这个<code>login.config</code>文件中设置了两个属性：<code>org.apache.activemq.jaas.properties.user</code>和<code>org.apache.activemq.jaas.properties.group</code>分别用来指向<code>user.properties</code>和<code>group.properties</code>文件。需要注意的是，<code>PropertiesLoginModule</code>使用本地文件的查找方式，而且查找时采用的base directory是<code>login.config</code>文件所在的目录。因此这个<code>login.config</code>说明<code>user.properties</code>和<code>group.properties</code>文件存放在跟<code>login.config</code>文件相同的目录里。<br>以下是ActiveMQ配置的一个例子： </p>
<pre><code>&lt;plugins&gt; 
        ... 
        &lt;jaasAuthenticationPlugin configuration=&quot;activemq-domain&quot; /&gt; 
&lt;/plugins&gt; 
</code></pre><p>基于以上的配置，在JAAS的<code>LoginContext</code>中会使用<code>activemq-domain</code>中配置的<code>PropertiesLoginModule</code>来进行登陆。<br>ActiveMQ JAAS还支持<code>LDAPLoginModule</code>、<code>CertificateLoginModule</code>、<code>TextFileCertificateLoginModule</code>等login module。 </p>
<h3 id="Custom-Authentication-Implementation"><a href="#Custom-Authentication-Implementation" class="headerlink" title="Custom Authentication Implementation"></a>Custom Authentication Implementation</h3><p>可以通过编码的方式为ActiveMQ增加认证功能。例如编写一个类继承自<code>XBeanBrokerService</code>。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">package com.yourpackage; </div><div class="line"></div><div class="line">import java.net.URI; </div><div class="line">import java.util.HashMap; </div><div class="line">import java.util.Map; </div><div class="line"></div><div class="line">import org.apache.activemq.broker.Broker; </div><div class="line">import org.apache.activemq.broker.BrokerFactory; </div><div class="line">import org.apache.activemq.broker.BrokerService; </div><div class="line">import org.apache.activemq.security.SimpleAuthenticationBroker; </div><div class="line">import org.apache.activemq.xbean.XBeanBrokerService; </div><div class="line"></div><div class="line">public class SimpleAuthBroker extends XBeanBrokerService &#123; </div><div class="line">        // </div><div class="line">        private String user; </div><div class="line">        private String password; </div><div class="line"></div><div class="line">        @SuppressWarnings(&quot;unchecked&quot;) </div><div class="line">        protected Broker addInterceptors(Broker broker) throws Exception &#123; </div><div class="line">                broker = super.addInterceptors(broker); </div><div class="line">                Map passwords = new HashMap(); </div><div class="line">                passwords.put(getUser(), getPassword()); </div><div class="line">                broker = new SimpleAuthenticationBroker(broker, passwords, new HashMap()); </div><div class="line">                return broker; </div><div class="line">        &#125; </div><div class="line"></div><div class="line">        public String getUser() &#123; </div><div class="line">              return user; </div><div class="line">        &#125; </div><div class="line"></div><div class="line">        public void setUser(String user) &#123; </div><div class="line">                this.user = user; </div><div class="line">        &#125; </div><div class="line"> </div><div class="line">    public String getPassword() &#123; </div><div class="line">         return password; </div><div class="line">    &#125; </div><div class="line">     </div><div class="line">    public void setPassword(String password) &#123; </div><div class="line">            this.password = password; </div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下是ActiveMQ配置文件的一个例子： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;beans&gt; </div><div class="line">    … </div><div class="line">    &lt;auth:SimpleAuthBroker </div><div class="line">    xmlns:auth=&quot;java://com.yourpackage&quot; </div><div class="line">    xmlns=&quot;http://activemq.org/config/1.0&quot; brokerName=&quot;SimpleAuthBroker1&quot; user=&quot;user&quot; password=&quot;password&quot; useJmx=&quot;true&quot;&gt; </div><div class="line"></div><div class="line">        &lt;transportConnectors&gt; </div><div class="line">                &lt;transportConnector uri=&quot;tcp://localhost:61616&quot;/&gt; </div><div class="line">        &lt;/transportConnectors&gt; </div><div class="line">    &lt;/auth:SimpleAuthBroker&gt; </div><div class="line">    … </div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
<p>在这个配置文件中增加了一个namespace auth，用于指向之前编写的哪个类。同时为<code>SimpleAuthBroker</code>注入了两个属性值<code>user</code>和<code>password</code>，因此在被<code>SimpleAuthBroker</code>改写的<code>addInterceptors</code>方法里，可以使用这两个属性进行认证了。ActiveMQ提供的<code>SimpleAuthenticationBroker</code>类继承自<code>BrokerFilter</code>可以简单的看成是Broker的Adaptor），它的构造函数中的两个<code>Map</code>分别是<code>userPasswords</code>和<code>userGroups</code>。<br><code>SimpleAuthenticationBroker</code>在<code>addConnection</code>方法中使用<code>userPasswords</code>进行认证，同时会把<code>userGroups</code>的信息保存到<code>ConnectionContext</code>中。</p>
<h3 id="Authorization-Plugin"><a href="#Authorization-Plugin" class="headerlink" title="Authorization Plugin"></a>Authorization Plugin</h3><p>可以通过Authorization Plugin为认证后的用户授权，以下ActiveMQ配置文件的一个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;plugins&gt; </div><div class="line">    &lt;jaasAuthenticationPlugin configuration=&quot;activemq-domain&quot;/&gt;  </div><div class="line">    &lt;authorizationPlugin&gt; </div><div class="line">        &lt;map&gt; </div><div class="line">            &lt;authorizationMap&gt; </div><div class="line">                &lt;authorizationEntries&gt; </div><div class="line">                    &lt;authorizationEntry queue=&quot;&gt;&quot; read=&quot;admins&quot; write=&quot;admins&quot; admin=&quot;admins&quot; /&gt; </div><div class="line">                    &lt;authorizationEntry queue=&quot;USERS.&gt;&quot; read=&quot;users&quot; write=&quot;users&quot; admin=&quot;users&quot; /&gt; </div><div class="line">                    &lt;authorizationEntry queue=&quot;GUEST.&gt;&quot; read=&quot;guests&quot; write=&quot;guests,users&quot; admin=&quot;guests,users&quot; /&gt; </div><div class="line">                    &lt;authorizationEntry topic=&quot;&gt;&quot; read=&quot;admins&quot; write=&quot;admins&quot; admin=&quot;admins&quot; /&gt; </div><div class="line">                    &lt;authorizationEntry topic=&quot;USERS.&gt;&quot; read=&quot;users&quot; write=&quot;users&quot; admin=&quot;users&quot; /&gt; </div><div class="line">                    &lt;authorizationEntry topic=&quot;GUEST.&gt;&quot; read=&quot;guests&quot; write=&quot;guests,users&quot; admin=&quot;guests,users&quot; /&gt; </div><div class="line">     </div><div class="line">                    &lt;authorizationEntry topic=&quot;ActiveMQ.Advisory.&gt;&quot; read=&quot;guests,users&quot; write=&quot;guests,users&quot; admin=&quot;guests,users&quot;/&gt; </div><div class="line">                &lt;/authorizationEntries&gt; </div><div class="line">            &lt;/authorizationMap&gt; </div><div class="line">        &lt;/map&gt; </div><div class="line">    &lt;/authorizationPlugin&gt; </div><div class="line">&lt;/plugins&gt;</div></pre></td></tr></table></figure></p>
<h2 id="Clustering"><a href="#Clustering" class="headerlink" title="Clustering"></a>Clustering</h2><p>ActiveMQ从多种不同的方面提供了集群的支持。 </p>
<h3 id="Queue-consumer-clusters"><a href="#Queue-consumer-clusters" class="headerlink" title="Queue consumer clusters"></a>Queue consumer clusters</h3><p>ActiveMQ支持订阅同一个queue的consumers上的集群。如果一个consumer失效，那么所有未被确认 （unacknowledged）的消息都会被发送到这个queue上其它的consumers。如果某个consumer的处理速度比其它consumers更快，那么这个consumer就会消费更多的消息。<br>需要注意的是，笔者发现AcitveMQ5.0版本的Queue consumer clusters存在一个bug：采用AMQ Message Store，运行一个producer，两个consumer，并采用如下的配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;beans&gt; </div><div class="line">    &lt;broker xmlns=&quot;http://activemq.org/config/1.0&quot; brokerName=&quot;BugBroker1&quot; useJmx=&quot;true&quot;&gt; </div><div class="line"></div><div class="line">        &lt;transportConnectors&gt; </div><div class="line">            &lt;transportConnector uri=&quot;tcp://localhost:61616&quot;/&gt; </div><div class="line">        &lt;/transportConnectors&gt; </div><div class="line"></div><div class="line">        &lt;persistenceAdapter&gt; </div><div class="line">            &lt;amqPersistenceAdapter directory=&quot;activemq-data/BugBroker1&quot; maxFileLength=&quot;32mb&quot;/&gt; </div><div class="line">        &lt;/persistenceAdapter&gt; </div><div class="line">     </div><div class="line">    &lt;/broker&gt; </div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure></p>
<p>那么经过一段时间后可能会报出如下错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ERROR [ActiveMQ Transport: tcp:///127.0.0.1:1843 - RecoveryListenerAdapter.java:58 - RecoveryListenerAdapter] Message id ID:versus-1837-1203915536609-0:2:1:1:419 could not be recovered from the data store!</div></pre></td></tr></table></figure></p>
<p>Apache官方文档说，此bug已经被修正，预定在5.1.0版本上体现。 </p>
<h3 id="Broker-clusters"><a href="#Broker-clusters" class="headerlink" title="Broker clusters"></a>Broker clusters</h3><p>一个常见的场景是有多个JMS broker，一个客户连接到其中一个broker。如果这个broker失效，那么客户会自动重新连接到其它的broker。在ActiveMQ中使用<code>failover://</code> 协议来实现这个功能。ActiveMQ3.x版本的<code>reliable://</code>协议已经变更为<code>failover://</code>。<br>如果某个网络上有多个brokers而且客户使用静态发现（使用Static Transport或Failover Transport）或动态发现（使用Discovery Transport），那么客户可以容易地在某个broker失效的情况下切换到其它的brokers。然而，stand alone brokers并不了解其它brokers上的consumers，也就是说如果某个broker上没有consumers，那么这个broker上的消息可能会因得不到处理而积压起来。目前的解决方案是使用Network of brokers，以便在broker之间存储转发消息。ActiveMQ在未来会有更好的特性，用来在客户端处理这个问题。<br>从ActiveMQ1.1版本起，ActiveMQ支持networks of brokers。它支持分布式的queues和topics。一个broker会相同对待所有的订阅（subscription）：不管他们是来自本地的客户连接，还是来自远程broker，它都会递送有关的消息拷贝到每个订阅。远程broker得到这个消息拷贝后，会依次把它递送到其内部的本地连接上。有两种方式配置Network of brokers，一种是使用static transport：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;broker brokerName=&quot;receiver&quot; persistent=&quot;false&quot; useJmx=&quot;false&quot;&gt; </div><div class="line">        &lt;transportConnectors&gt; </div><div class="line">                &lt;transportConnector uri=&quot;tcp://localhost:62002&quot;/&gt; </div><div class="line">        &lt;/transportConnectors&gt; </div><div class="line">        </div><div class="line">        &lt;networkConnectors&gt; </div><div class="line">                &lt;networkConnector uri=&quot;static:( tcp://localhost:61616,tcp://remotehost:61616)&quot;/&gt; </div><div class="line">        &lt;/networkConnectors&gt; </div><div class="line">… </div><div class="line">&lt;/broker&gt;</div></pre></td></tr></table></figure></p>
<p>另外一种是使用multicast discovery，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;broker name=&quot;sender&quot; persistent=&quot;false&quot; useJmx=&quot;false&quot;&gt; </div><div class="line">    &lt;transportConnectors&gt; </div><div class="line">        &lt;transportConnector uri=&quot;tcp://localhost:0&quot; discoveryUri=&quot;multicast://default&quot;/&gt; </div><div class="line">    &lt;/transportConnectors&gt; </div><div class="line">    &lt;networkConnectors&gt; </div><div class="line">        &lt;networkConnector uri=&quot;multicast://default&quot;/&gt; </div><div class="line">    &lt;/networkConnectors&gt; </div><div class="line">... </div><div class="line">&lt;/broker&gt;</div></pre></td></tr></table></figure></p>
<p>Network Connector有以下属性： </p>
<table>
<thead>
<tr>
<th style="text-align:center">Property</th>
<th style="text-align:center">Default Value</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">bridge</td>
<td style="text-align:center">name of the network - for more than one network connector between the same two brokers - use different names</td>
</tr>
<tr>
<td style="text-align:center">dynamicOnly</td>
<td style="text-align:center">false</td>
<td style="text-align:center">if true, only forward messages if a consumer is active on the connected broker</td>
</tr>
<tr>
<td style="text-align:center">decreaseNetworkConsumerPriority</td>
<td style="text-align:center">false</td>
<td style="text-align:center">decrease the priority for dispatching to a Queue consumer the further away it is (in network hops) from the producer</td>
</tr>
<tr>
<td style="text-align:center">networkTTL</td>
<td style="text-align:center">1</td>
<td style="text-align:center">the number of brokers in the network that messages and subscriptions can pass through</td>
</tr>
<tr>
<td style="text-align:center">conduitSubscriptions</td>
<td style="text-align:center">true</td>
<td style="text-align:center">multiple consumers subscribing to the same destination are treated as one consumer by the network</td>
</tr>
<tr>
<td style="text-align:center">excludedDestinations</td>
<td style="text-align:center">empty</td>
<td style="text-align:center">destinations matching this list won’t be forwarded across the network</td>
</tr>
<tr>
<td style="text-align:center">dynamicallyIncludedDestinations</td>
<td style="text-align:center">empty</td>
<td style="text-align:center">destinations that match this list will be forwarded across the network n.b. an empty list means all destinations not in the excluded list will be forwarded</td>
</tr>
<tr>
<td style="text-align:center">staticallyIncludedDestinations</td>
<td style="text-align:center">empty</td>
<td style="text-align:center">destinations that match will always be passed across the network - even if no consumers have ever registered an interest</td>
</tr>
<tr>
<td style="text-align:center">duplex</td>
<td style="text-align:center">false</td>
<td style="text-align:center">if true, a network connection will be used to both produce AND Consume messages. This is useful for hub and spoke scenarios when the hub is behind a firewall etc.</td>
</tr>
</tbody>
</table>
<p>关于conduitSubscriptions属性，这里稍稍说明一下。设想有两个brokers，分别是brokerA和brokerB，它们之间用 forwarding bridge连接。有一个consumer连接到brokerA并订阅queue：<code>Q.TEST</code>。有两个consumers连接到brokerB，也是订 阅queue：<code>Q.TEST</code>。这三个consumers有相同的优先级。然后启动一个producer。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/JMS/" rel="tag"># JMS</a>
          
            <a href="/tags/ActiveMQ/" rel="tag"># ActiveMQ</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/05/activemq/ActiveMQ_初步入门及相关概念理解/" rel="next" title="JMS概念">
                <i class="fa fa-chevron-left"></i> JMS概念
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/06/activemq/ActiveMQ实现负载均衡_高可用部署方案/" rel="prev" title="ActiveMQ实现负载均衡+高可用部署方案">
                ActiveMQ实现负载均衡+高可用部署方案 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="hypercomments_widget"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="技术随手记" />
          <p class="site-author-name" itemprop="name">技术随手记</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">66</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">40</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">47</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Running-Broker"><span class="nav-number">1.</span> <span class="nav-text">Running Broker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Embedded-Broker"><span class="nav-number">2.</span> <span class="nav-text">Embedded Broker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#可以通过BrokerFactory来创建broker，例如："><span class="nav-number">3.</span> <span class="nav-text">可以通过BrokerFactory来创建broker，例如：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Monitoring-Broker"><span class="nav-number">4.</span> <span class="nav-text">Monitoring Broker</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JMX"><span class="nav-number">4.1.</span> <span class="nav-text">JMX</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Web-Console"><span class="nav-number">4.2.</span> <span class="nav-text">Web Console</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Advisory-Message"><span class="nav-number">4.3.</span> <span class="nav-text">Advisory Message</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Command-Agent"><span class="nav-number">4.4.</span> <span class="nav-text">Command Agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Visualization-plugin"><span class="nav-number">4.5.</span> <span class="nav-text">Visualization plugin</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Transport"><span class="nav-number">5.</span> <span class="nav-text">Transport</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VM-Transport"><span class="nav-number">5.1.</span> <span class="nav-text">VM Transport</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-Transport"><span class="nav-number">5.2.</span> <span class="nav-text">TCP Transport</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Failover-Transport"><span class="nav-number">5.3.</span> <span class="nav-text">Failover Transport</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Discovery-transport"><span class="nav-number">5.4.</span> <span class="nav-text">Discovery transport</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Persistence"><span class="nav-number">6.</span> <span class="nav-text">Persistence</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AMQ-Message-Store"><span class="nav-number">6.1.</span> <span class="nav-text">AMQ Message Store</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kaha-Persistence"><span class="nav-number">6.2.</span> <span class="nav-text">Kaha Persistence</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDBC-Persistence"><span class="nav-number">6.3.</span> <span class="nav-text">JDBC Persistence</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Disable-Persistence"><span class="nav-number">6.4.</span> <span class="nav-text">Disable Persistence</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security"><span class="nav-number">7.</span> <span class="nav-text">Security</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Simple-Authentication-Plugin"><span class="nav-number">7.1.</span> <span class="nav-text">Simple Authentication Plugin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JAAS-Authentication-Plugin"><span class="nav-number">7.2.</span> <span class="nav-text">JAAS Authentication Plugin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-Authentication-Implementation"><span class="nav-number">7.3.</span> <span class="nav-text">Custom Authentication Implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Authorization-Plugin"><span class="nav-number">7.4.</span> <span class="nav-text">Authorization Plugin</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Clustering"><span class="nav-number">8.</span> <span class="nav-text">Clustering</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Queue-consumer-clusters"><span class="nav-number">8.1.</span> <span class="nav-text">Queue consumer clusters</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Broker-clusters"><span class="nav-number">8.2.</span> <span class="nav-text">Broker clusters</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">技术随手记</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	

		<script type="text/javascript">
		_hcwp = window._hcwp || [];

		_hcwp.push({widget:"Bloggerstream", widget_id: 89144, selector:".hc-comment-count", label: "{\%COUNT%\}" });

		
		_hcwp.push({widget:"Stream", widget_id: 89144, xid: "2017/04/06/activemq/ActiveMQ理解/"});
		

		(function() {
		if("HC_LOAD_INIT" in window)return;
		HC_LOAD_INIT = true;
		var lang = (navigator.language || navigator.systemLanguage || navigator.userLanguage || "en").substr(0, 2).toLowerCase();
		var hcc = document.createElement("script"); hcc.type = "text/javascript"; hcc.async = true;
		hcc.src = ("https:" == document.location.protocol ? "https" : "http")+"://w.hypercomments.com/widget/hc/89144/"+lang+"/widget.js";
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(hcc, s.nextSibling);
		})();
		</script>

	












  





  

  

  

  

</body>
</html>
