<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>技术随手记</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://jishusuishouji.github.io/"/>
  <updated>2017-03-23T14:56:11.658Z</updated>
  <id>http://jishusuishouji.github.io/</id>
  
  <author>
    <name>技术随手记</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>druid 配置WebStatFilter 网络url统计</title>
    <link href="http://jishusuishouji.github.io/2017/03/23/druid/druid_%E9%85%8D%E7%BD%AEWebStatFilter_%E7%BD%91%E7%BB%9Curl%E7%BB%9F%E8%AE%A1/"/>
    <id>http://jishusuishouji.github.io/2017/03/23/druid/druid_配置WebStatFilter_网络url统计/</id>
    <published>2017-03-23T14:54:59.000Z</published>
    <updated>2017-03-23T14:56:11.658Z</updated>
    
    <content type="html"><![CDATA[<p>WebStatFilter用于采集web-jdbc关联监控的数据。<br><a id="more"></a><br>web.xml配置<br>[html] view plain copy</p>
<p><filter><br>  <filter-name>DruidWebStatFilter</filter-name><br>  <filter-class>com.alibaba.druid.support.http.WebStatFilter</filter-class><br>  <init-param><br>      <param-name>exclusions</param-name><br>      <param-value><em>.js,</em>.gif,<em>.jpg,</em>.png,<em>.css,</em>.ico,/druid/*</param-value><br>  </init-param><br></filter>  </p>
<p><filter-mapping><br>  <filter-name>DruidWebStatFilter</filter-name><br>  <url-pattern>/*</url-pattern><br></filter-mapping>  </p>
<p>exlusions配置<br>经常需要排除一些不必要的url，比如.js,/jslib/等等。配置在init-param中。比如：</p>
<p>[html] view plain copy</p>
<p><init-param><br>    <param-name>exclusions</param-name><br>    <param-value><em>.js,</em>.gif,<em>.jpg,</em>.png,<em>.css,</em>.ico,/druid/*</param-value><br></init-param>  </p>
<p>sessionStatMaxCount配置<br>缺省sessionStatMaxCount是1000个。你可以按需要进行配置，比如：</p>
<p>[html] view plain copy</p>
<p><init-param><br>    <param-name>sessionStatMaxCount</param-name><br>    <param-value>1000</param-value><br></init-param>  </p>
<p>sessionStatEnable配置<br>你可以关闭session统计功能，比如：</p>
<p>[html] view plain copy</p>
<p><init-param><br>    <param-name>sessionStatEnable</param-name><br>    <param-value>false</param-value><br></init-param>  </p>
<p>principalSessionName配置<br>你可以配置principalSessionName，使得druid能够知道当前的session的用户是谁。比如：</p>
<p>[html] view plain copy</p>
<p><init-param><br>    <param-name>principalSessionName</param-name><br>    <param-value>xxx.user</param-value><br></init-param>  </p>
<p>根据需要，把其中的xxx.user修改为你user信息保存在session中的sessionName。</p>
<p>注意：如果你session中保存的是非string类型的对象，需要重载toString方法<br>principalCookieName<br>如果你的user信息保存在cookie中，你可以配置principalCookieName，使得druid知道当前的user是谁<br>[html] view plain copy</p>
<p><init-param><br>    <param-name>principalCookieName</param-name><br>    <param-value>xxx.user</param-value><br></init-param>  </p>
<p>根据需要，把其中的xxx.user修改为你user信息保存在cookie中的cookieName<br>profileEnable<br>druid 0.2.7版本开始支持profile，配置profileEnable能够监控单个url调用的sql列表。</p>
<p>[html] view plain copy</p>
<p><init-param><br>    <param-name>profileEnable</param-name><br>    <param-value>true</param-value><br></init-param>  </p>
]]></content>
    
    <summary type="html">
    
      druid 配置WebStatFilter 网络url统计
    
    </summary>
    
      <category term="druid" scheme="http://jishusuishouji.github.io/categories/druid/"/>
    
    
      <category term="druid" scheme="http://jishusuishouji.github.io/tags/druid/"/>
    
  </entry>
  
  <entry>
    <title>DRUID连接池的实用 配置详解</title>
    <link href="http://jishusuishouji.github.io/2017/03/23/druid/DRUID%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%9A%84%E5%AE%9E%E7%94%A8_%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/"/>
    <id>http://jishusuishouji.github.io/2017/03/23/druid/DRUID连接池的实用_配置详解/</id>
    <published>2017-03-23T14:03:57.000Z</published>
    <updated>2017-03-23T14:57:31.301Z</updated>
    
    <content type="html"><![CDATA[<h2 id="DRUID介绍"><a href="#DRUID介绍" class="headerlink" title="DRUID介绍"></a>DRUID介绍</h2><p>DRUID是阿里巴巴开源平台上一个数据库连接池实现，它结合了C3P0、DBCP、PROXOOL等DB池的优点，同时加入了日志监控，可以很好的监控DB池连接和SQL的执行情况，可以说是<strong>针对监控而生的DB连接池</strong>(据说是目前最好的连接池,不知道速度有没有BoneCP快)。<br><a id="more"></a></p>
<h2 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h2><p>和其它连接池一样DRUID的<code>DataSource</code>类为：<code>com.alibaba.druid.pool.DruidDataSource</code>，基本配置参数如下：</p>
<ul>
<li><code>name</code> 配置这个属性的意义在于，如果存在多个数据源，监控的时候可以通过名字来区分开来。<br>如果没有配置，将会生成一个名字，格式是：”DataSource-“ + <code>System.identityHashCode(this)</code>  </li>
<li><code>jdbcUrl</code><br>连接数据库的url，不同数据库不一样。例如：<br><code>mysql:jdbc:mysql://10.20.153.104:3306/druid2</code><br><code>oracle:jdbc:oracle:thin:@10.20.149.85:1521:ocnauto</code></li>
<li><code>username</code><br>连接数据库的用户名</li>
<li><code>password</code><br>连接数据库的密码。如果你不希望密码直接写在配置文件中，可以使用<code>ConfigFilter</code>。</li>
<li><code>driverClassName</code><br>根据url自动识别<br>这一项可配可不配，如果不配置druid会根据url自动识别dbType，然后选择相应的<code>driverClassName</code>(建议配置下)</li>
<li><code>initialSize</code><br>默认值0，初始化时建立物理连接的个数。初始化发生在显示调用<code>init</code>方法，或者第一次<code>getConnection</code>时</li>
<li><code>maxActive</code><br>默认值8<br>最大连接池数量</li>
<li><code>maxIdle</code><br>默认值8<br>已经不再使用，配置了也没效果</li>
<li><code>minIdle</code><br>最小连接池数量</li>
<li><code>maxWait</code><br>获取连接时最大等待时间，单位毫秒。配置了<code>maxWait</code>之后，缺省启用公平锁，并发效率会有所下降，如果需要可以通过配置<code>useUnfairLock</code>属性为<code>true</code>使用非公平锁。</li>
<li><code>poolPreparedStatements</code><br><code>false</code><br>是否缓存<code>preparedStatement</code>，也就是<code>PSCache</code>。PSCache对支持游标的数据库性能提升巨大，比如说oracle。在mysql下建议关闭。</li>
<li><code>maxOpenPreparedStatements</code><br><code>-1</code><br>要启用<code>PSCache</code>，必须配置大于0，当大于0时，<code>poolPreparedStatements</code>自动触发修改为<code>true</code>。在Druid中，不会存在Oracle下<code>PSCache</code>占用内存过多的问题，可以把这个数值配置大一些，比如说100</li>
<li><code>validationQuery</code><br>用来检测连接是否有效的sql，要求是一个查询语句。如果<code>validationQuery</code>为<code>null</code>，<code>testOnBorrow</code>、<code>testOnReturn</code>、<code>testWhileIdle</code>都不会其作用。</li>
<li><code>testOnBorrow</code><br><code>true</code><br>申请连接时执行<code>validationQuery</code>检测连接是否有效，做了这个配置会降低性能。</li>
<li><code>testOnReturn</code><br><code>false</code><br>归还连接时执行<code>validationQuery</code>检测连接是否有效，做了这个配置会降低性能</li>
<li><code>testWhileIdle</code><br><code>false</code><br>建议配置为<code>true</code>，不影响性能，并且保证安全性。申请连接的时候检测，如果空闲时间大于<code>timeBetweenEvictionRunsMillis</code>，执行<code>validationQuery</code>检测连接是否有效。<br><code>timeBetweenEvictionRunsMillis</code><br>有两个含义：<br>1) <code>Destroy</code>线程会检测连接的间隔时间<br>2) <code>testWhileIdle</code>的判断依据，详细看<code>testWhileIdle</code>属性的说明</li>
<li><code>numTestsPerEvictionRun</code><br>不再使用，一个DruidDataSource只支持一个<code>EvictionRun</code></li>
<li><code>minEvictableIdleTimeMillis</code><br><code>connectionInitSqls</code><br>物理连接初始化的时候执行的sql</li>
<li><code>exceptionSorter</code><br>根据dbType自动识别<br>当数据库抛出一些不可恢复的异常时，抛弃连接</li>
<li><code>filters</code><br>属性类型是字符串，通过别名的方式配置扩展插件，常用的插件有：<br>监控统计用的filter:stat<br>日志用的filter:log4j<br>防御sql注入的filter:wall</li>
<li><code>proxyFilters</code><br>类型是<code>List&lt;com.alibaba.druid.filter.Filter&gt;</code>，如果同时配置了filters和proxyFilters，是组合关系，并非替换关系</li>
</ul>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>DB数据源的使用方法也就是2种，一种是在代码中写死通过NEW操作符创建<code>DataSSource</code>，然后set一些连接属性;另外一种是基于SPRING的配置方法，然后让SPRING的Context自动加载配置（以下配置文件默认都在项目根目录下conf文件夹中）</p>
<p>1、属性文件:<code>application.properties</code>(DataSource连接参数)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">jdbc.driverClassName=com.mysql.jdbc.Driver </div><div class="line">jdbc.url=jdbc:mysql://127.0.0.1:3306/test </div><div class="line">jdbc.username=root </div><div class="line">jdbc.password=1qaz!QAZ</div></pre></td></tr></table></figure>
<p>2、SPRING配置文件：<code>spring-base.xml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; </div><div class="line">&lt;beans xmlns=&quot; http://www.springframework.org/schema/beans&quot; </div><div class="line"> xmlns:xsi=&quot; http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:batch=&quot; http://www.springframework.org/schema/batch&quot; </div><div class="line"> xsi:schemaLocation=&quot; http://www.springframework.org/schema/beans </div><div class="line">           http://www.springframework.org/schema/beans/spring-beans-4.0.xsd&quot;&gt;</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"> &lt;bean id=&quot;propertyConfigure&quot; </div><div class="line">  class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt; </div><div class="line">  &lt;property name=&quot;locations&quot;&gt; </div><div class="line">   &lt;list&gt; </div><div class="line">    &lt;value&gt;./conf/application.properties&lt;/value&gt; </div><div class="line">   &lt;/list&gt; </div><div class="line">  &lt;/property&gt; </div><div class="line"> &lt;/bean&gt;</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"> &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot; </div><div class="line">  init-method=&quot;init&quot; destroy-method=&quot;close&quot;&gt; </div><div class="line">  &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;jdbc.driverClassName&#125;&quot; /&gt; </div><div class="line">  &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt; </div><div class="line">  &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot; /&gt; </div><div class="line">  &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt; </div><div class="line">  &lt;!-- 配置初始化大小、最小、最大 --&gt; </div><div class="line">  &lt;property name=&quot;initialSize&quot; value=&quot;1&quot; /&gt; </div><div class="line">  &lt;property name=&quot;minIdle&quot; value=&quot;1&quot; /&gt; </div><div class="line">  &lt;property name=&quot;maxActive&quot; value=&quot;10&quot; /&gt;</div><div class="line"></div><div class="line">  &lt;!-- 配置获取连接等待超时的时间 --&gt; </div><div class="line">  &lt;property name=&quot;maxWait&quot; value=&quot;10000&quot; /&gt;</div><div class="line"></div><div class="line">  &lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt; </div><div class="line">  &lt;property name=&quot;timeBetweenEvictionRunsMillis&quot; value=&quot;60000&quot; /&gt;</div><div class="line"></div><div class="line">  &lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt; </div><div class="line">  &lt;property name=&quot;minEvictableIdleTimeMillis&quot; value=&quot;300000&quot; /&gt;</div><div class="line"></div><div class="line">  &lt;property name=&quot;testWhileIdle&quot; value=&quot;true&quot; /&gt;</div><div class="line"></div><div class="line">  &lt;!-- 这里建议配置为TRUE，防止取到的连接不可用 --&gt; </div><div class="line">  &lt;property name=&quot;testOnBorrow&quot; value=&quot;true&quot; /&gt; </div><div class="line">  &lt;property name=&quot;testOnReturn&quot; value=&quot;false&quot; /&gt;</div><div class="line"></div><div class="line">  &lt;!-- 打开PSCache，并且指定每个连接上PSCache的大小 --&gt; </div><div class="line">  &lt;property name=&quot;poolPreparedStatements&quot; value=&quot;true&quot; /&gt; </div><div class="line">  &lt;property name=&quot;maxPoolPreparedStatementPerConnectionSize&quot; </div><div class="line">   value=&quot;20&quot; /&gt;</div><div class="line"></div><div class="line">  &lt;!-- 这里配置提交方式，默认就是TRUE，可以不用配置 --&gt;</div><div class="line"></div><div class="line">  &lt;property name=&quot;defaultAutoCommit&quot; value=&quot;true&quot; /&gt;</div><div class="line"></div><div class="line">  &lt;!-- 验证连接有效与否的SQL，不同的数据配置不同 --&gt; </div><div class="line">  &lt;property name=&quot;validationQuery&quot; value=&quot;select 1 &quot; /&gt; </div><div class="line">  &lt;property name=&quot;filters&quot; value=&quot;stat&quot; /&gt; </div><div class="line">  &lt;property name=&quot;proxyFilters&quot;&gt; </div><div class="line">   &lt;list&gt; </div><div class="line">    &lt;ref bean=&quot;logFilter&quot; /&gt; </div><div class="line">   &lt;/list&gt; </div><div class="line">  &lt;/property&gt; </div><div class="line"> &lt;/bean&gt;</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"> &lt;bean id=&quot;logFilter&quot; class=&quot;com.alibaba.druid.filter.logging.Slf4jLogFilter&quot;&gt; </div><div class="line">  &lt;property name=&quot;statementExecutableSqlLogEnable&quot; value=&quot;false&quot; /&gt; </div><div class="line"> &lt;/bean&gt;</div><div class="line"></div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
<h2 id="监控方式"><a href="#监控方式" class="headerlink" title="监控方式"></a>监控方式</h2><h3 id="1、WEB方式监控配置"><a href="#1、WEB方式监控配置" class="headerlink" title="1、WEB方式监控配置"></a>1、WEB方式监控配置</h3><pre><code>&lt;servlet&gt; 
     &lt;servlet-name&gt;DruidStatView&lt;/servlet-name&gt; 
     &lt;servlet-class&gt;com.alibaba.druid.support.http.StatViewServlet&lt;/servlet-class&gt; 
 &lt;/servlet&gt; 
 &lt;servlet-mapping&gt; 
     &lt;servlet-name&gt;DruidStatView&lt;/servlet-name&gt; 
     &lt;url-pattern&gt;/druid/*&lt;/url-pattern&gt; 
 &lt;/servlet-mapping&gt; 
 &lt;filter&gt; 
  &lt;filter-name&gt;druidWebStatFilter&lt;/filter-name&gt; 
  &lt;filter-class&gt;com.alibaba.druid.support.http.WebStatFilter&lt;/filter-class&gt; 
  &lt;init-param&gt; 
   &lt;param-name&gt;exclusions&lt;/param-name&gt; 
   &lt;param-value&gt;/public/*,*.js,*.css,/druid*,*.jsp,*.swf&lt;/param-value&gt; 
  &lt;/init-param&gt; 
  &lt;init-param&gt; 
   &lt;param-name&gt;principalSessionName&lt;/param-name&gt; 
   &lt;param-value&gt;sessionInfo&lt;/param-value&gt; 
  &lt;/init-param&gt; 
  &lt;init-param&gt; 
   &lt;param-name&gt;profileEnable&lt;/param-name&gt; 
   &lt;param-value&gt;true&lt;/param-value&gt; 
  &lt;/init-param&gt; 
 &lt;/filter&gt; 
 &lt;filter-mapping&gt; 
  &lt;filter-name&gt;druidWebStatFilter&lt;/filter-name&gt; 
  &lt;url-pattern&gt;/*&lt;/url-pattern&gt; 
 &lt;/filter-mapping&gt;
</code></pre><p>把上面servlet配置添加到项目<code>web.xml</code>即可。然后运行Tomcat，浏览器输入 <a href="http://IP:PROT/druid" target="_blank" rel="external">http://IP:PROT/druid</a></p>
<p>就可以打开Druid的监控页面了.</p>
<h3 id="2、日志文件监控"><a href="#2、日志文件监控" class="headerlink" title="2、日志文件监控"></a>2、日志文件监控</h3><p>Druid提供了多种日志文件监控commons-logging、log4j等，这里我们主要使用slf4j和logback来进行日志监控配置。</p>
<p>首先要引入slf4j和logback相关的jar文件（从Maven公共仓库下载 <a href="http://search.maven.org/）" target="_blank" rel="external">http://search.maven.org/）</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;slf4j.version&gt;1.7.7&lt;/slf4j.version&gt; </div><div class="line">&lt;logback.version&gt;1.1.2&lt;/logback.version&gt;</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line">&lt;dependency&gt; </div><div class="line">    &lt;groupId&gt;org.slf4j&lt;/groupId&gt; </div><div class="line">    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt; </div><div class="line">    &lt;version&gt;$&#123;slf4j.version&#125;&lt;/version&gt; </div><div class="line"> &lt;/dependency&gt; </div><div class="line">&lt;dependency&gt; </div><div class="line">    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt; </div><div class="line">    &lt;artifactId&gt;logback-access&lt;/artifactId&gt; </div><div class="line">    &lt;version&gt;$&#123;logback.version&#125;&lt;/version&gt; </div><div class="line">&lt;/dependency&gt; </div><div class="line">&lt;dependency&gt; </div><div class="line">    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt; </div><div class="line">    &lt;artifactId&gt;logback-core&lt;/artifactId&gt; </div><div class="line">    &lt;version&gt;$&#123;logback.version&#125;&lt;/version&gt; </div><div class="line">&lt;/dependency&gt; </div><div class="line">&lt;dependency&gt; </div><div class="line">    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt; </div><div class="line">    &lt;artifactId&gt;logback-classic&lt;/artifactId&gt; </div><div class="line">    &lt;version&gt;$&#123;logback.version&#125;&lt;/version&gt; </div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>接下配置logback的配置文件(<code>./conf/logback.xml</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line"></div><div class="line"> &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt; </div><div class="line">  &lt;layout class=&quot;ch.qos.logback.classic.PatternLayout&quot;&gt; </div><div class="line">   &lt;Pattern&gt;%d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n </div><div class="line">   &lt;/Pattern&gt; </div><div class="line">  &lt;/layout&gt; </div><div class="line"> &lt;/appender&gt;</div><div class="line"></div><div class="line"> &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.FileAppender&quot;&gt; </div><div class="line">  &lt;file&gt;./logs/druid_info.log&lt;/file&gt; </div><div class="line">  &lt;layout class=&quot;ch.qos.logback.classic.PatternLayout&quot;&gt; </div><div class="line">   &lt;Pattern&gt;%d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/Pattern&gt; </div><div class="line">  &lt;/layout&gt; </div><div class="line">  &lt;filter class=&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;&gt; </div><div class="line">   &lt;level&gt;debug&lt;/level&gt; </div><div class="line">  &lt;/filter&gt; </div><div class="line"> &lt;/appender&gt;</div><div class="line"></div><div class="line"> &lt;root level=&quot;DEBUG&quot;&gt; </div><div class="line">  &lt;appender-ref ref=&quot;FILE&quot; /&gt; </div><div class="line"> &lt;/root&gt; </div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<p>最后就是写一个测试类进行测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public class TestMain &#123;</div><div class="line"></div><div class="line"> public static void loadLoggerContext() &#123; </div><div class="line">  System.getProperties().put(&quot;logback.configurationFile&quot;, &quot;./conf/logback.xml&quot;); </div><div class="line">  LoggerContext lc = (LoggerContext) LoggerFactory.getILoggerFactory(); </div><div class="line">  StatusPrinter.setPrintStream(System.err); </div><div class="line">  StatusPrinter.print(lc); </div><div class="line"> &#125;</div><div class="line"></div><div class="line"> public static void main(String[] args) &#123; </div><div class="line">  try &#123; </div><div class="line">   loadLoggerContext(); </div><div class="line">   FileSystemXmlApplicationContext context = new FileSystemXmlApplicationContext(&quot;./conf/spring-base.xml&quot;); </div><div class="line"></div><div class="line">  &#125; catch (Exception e) &#123; </div><div class="line">   System.out.println(e); </div><div class="line">  &#125; </div><div class="line"> &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      DRUID连接池的实用 配置详解
    
    </summary>
    
      <category term="Druid" scheme="http://jishusuishouji.github.io/categories/Druid/"/>
    
    
      <category term="Druid" scheme="http://jishusuishouji.github.io/tags/Druid/"/>
    
  </entry>
  
  <entry>
    <title>Druid：一个用于大数据实时处理的开源分布式系统</title>
    <link href="http://jishusuishouji.github.io/2017/03/23/druid/Druid%EF%BC%9A%E4%B8%80%E4%B8%AA%E7%94%A8%E4%BA%8E%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6%E5%A4%84%E7%90%86%E7%9A%84%E5%BC%80%E6%BA%90%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/"/>
    <id>http://jishusuishouji.github.io/2017/03/23/druid/Druid：一个用于大数据实时处理的开源分布式系统/</id>
    <published>2017-03-23T14:00:02.000Z</published>
    <updated>2017-03-23T14:02:58.182Z</updated>
    
    <content type="html"><![CDATA[<p>Druid是一个用于大数据实时查询和分析的高容错、高性能开源分布式系统，旨在快速处理大规模的数据，并能够实现快速查询和分析。尤其是当发生代码部署、机器故障以及其他产品系统遇到宕机等情况时，Druid仍能够保持100%正常运行。创建Druid的最初意图主要是为了解决查询延迟问题，当时试图使用Hadoop来实现交互式查询分析，但是很难满足实时分析的需要。而Druid提供了以交互方式访问数据的能力，并权衡了查询的灵活性和性能而采取了特殊的存储格式。<br><a id="more"></a><br>Druid功能介于PowerDrill和Dremel之间，它几乎实现了Dremel的所有功能，并且从PowerDrill吸收一些有趣的数据格式。Druid允许以类似Dremel和PowerDrill的方式进行单表查询，同时还增加了一些新特性，如为局部嵌套数据结构提供列式存储格式、为快速过滤做索引、实时摄取和查询、高容错的分布式体系架构等。从官方得知，Druid的具有以下主要特征：</p>
<ul>
<li>为分析而设计——Druid是为OLAP工作流的探索性分析而构建，它支持各种过滤、聚合和查询等类；</li>
<li>快速的交互式查询——Druid的低延迟数据摄取架构允许事件在它们创建后毫秒内可被查询到；</li>
<li>高可用性——Druid的数据在系统更新时依然可用，规模的扩大和缩小都不会造成数据丢失；</li>
<li>可扩展——Druid已实现每天能够处理数十亿事件和TB级数据。</li>
<li>Druid应用最多的是类似于广告分析创业公司Metamarkets中的应用场景，如广告分析、互联网广告系统监控以及网络监控等。当业务中出现以下情况时，Druid是一个很好的技术方案选择：</li>
</ul>
<p>需要交互式聚合和快速探究大量数据时；<br>需要实时查询分析时；<br>具有大量数据时，如每天数亿事件的新增、每天数10T数据的增加；<br>对数据尤其是大数据进行实时分析时；<br>需要一个高可用、高容错、高性能数据库时。<br>一个Druid集群有各种类型的节点（Node）组成，每个节点都可以很好的处理一些的事情，这些节点包括对非实时数据进行处理存储和查询的Historical节点、实时摄取数据、监听输入数据流的Realtime节、监控Historical节点的Coordinator节点、接收来自外部客户端的查询和将查询转发到Realtime和Historical节点的Broker节点、负责索引服务的Indexer节点。</p>
<p>查询操作中数据流和各个节点的关系如下图所示：</p>
<p>如下图是Druid集群的管理层架构，该图展示了相关节点和集群管理所依赖的其他组件（如负责服务发现的ZooKeeper集群）的关系：</p>
<p>Druid已基于Apache License 2.0协议开源，代码托管在GitHub，其当前最新稳定版本是0.7.1.1。当前，Druid已有63个代码贡献者和将近2000个关注。Druid的主要贡献者包括广告分析创业公司Metamarkets、电影流媒体网站Netflix、Yahoo等公司。Druid官方还对Druid同Shark、Vertica、Cassandra、Hadoop、Spark、Elasticsearch等在容错能力、灵活性、查询性能等方便进行了对比说明。更多关于Druid的信息，大家还可以参考官方提供的入门教程、白皮书 、设计文档等。</p>
<p>感谢徐川对本文的审校。</p>
]]></content>
    
    <summary type="html">
    
      Druid：一个用于大数据实时处理的开源分布式系统
    
    </summary>
    
      <category term="Druid" scheme="http://jishusuishouji.github.io/categories/Druid/"/>
    
    
      <category term="Druid" scheme="http://jishusuishouji.github.io/tags/Druid/"/>
    
  </entry>
  
  <entry>
    <title>架构师必看 京东咚咚架构演进</title>
    <link href="http://jishusuishouji.github.io/2017/03/21/jiagou/%E6%9E%B6%E6%9E%84%E5%B8%88%E5%BF%85%E7%9C%8B_%E4%BA%AC%E4%B8%9C%E5%92%9A%E5%92%9A%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/"/>
    <id>http://jishusuishouji.github.io/2017/03/21/jiagou/架构师必看_京东咚咚架构演进/</id>
    <published>2017-03-21T13:01:44.000Z</published>
    <updated>2017-03-21T15:09:25.722Z</updated>
    
    <content type="html"><![CDATA[<p>技术架构单独拿出来看我认为没有绝对的好与不好，技术架构总是要放在彼时的背景下来看，要考虑业务的时效价值、团队的规模和能力、环境基础设施等等方面。 架构演进的生命周期适时匹配好业务的生命周期，才可能发挥最好的效果。</p>
<h2 id="京东咚咚"><a href="#京东咚咚" class="headerlink" title="京东咚咚"></a>京东咚咚</h2><p>自从京东开始为第三方卖家提供入驻平台服务后，咚咚也就随之诞生了。 </p>
<h3 id="1-0-诞生（2010-–-2011"><a href="#1-0-诞生（2010-–-2011" class="headerlink" title="1.0 诞生（2010 – 2011)"></a>1.0 诞生（2010 – 2011)</h3><p>为了业务的快速上线，1.0 版本的技术架构实现是非常直接且简单粗暴的。 如何简单粗暴法？请看架构图，如下。<br><img src="/img/京东咚咚1.0.jpg" alt="京东咚咚1.0"><br>京东咚咚1.0的功能十分简单，实现了一个IM的基本功能，接入、互通消息和状态。另外还有客服功能，就是顾客接入咨询时的客服分配，按轮询方式把顾客分配给在线的客服接待。 用开源Mina框架实现了TCP的长连接接入，用Tomcat Comet机制实现了HTTP的长轮询服务。而消息投递的实现是一端发送的消息临时存放在 Redis中，另一端拉取的生产消费模型。<br>这个模型的做法导致需要以一种高频率的方式来轮询Redis遍历属于自己连接的关联会话消息。这个模型很简单，简单包括多个层面的意思：理解起来简单；开发起来简单；部署起来也简单。只需要一个Tomcat应用依赖一个共享的Redis，简单的实现核心业务功能，并支持业务快速上线。<br>但这个简单的模型也有些严重的缺陷，主要是效率和扩展问题。轮询的频率间隔大小基本决定了消息的延时，轮询越快延时越低，但轮询越快消耗也越高。这个模型实际上是一个高功耗低效能的模型，因为不活跃的连接在那做高频率的无意义轮询。 高频有多高呢，基本在100ms以内，你不能让轮询太慢，比如超过2秒轮一次，人就会在聊天过程中感受到明显的会话延迟。 随着在线人数增加，轮询的耗时也线性增长，因此这个模型导致了扩展能力和承载能力都不好，一定会随着在线人数的增长碰到性能瓶颈。</p>
<p>1.0的时代背景正是京东技术平台从.NET向Java转型的年代，我也正是在这期间加入京东并参与了京东主站技术转型架构升级的过程。 之后开始接手了京东咚咚，并持续完善这个产品，进行了三次技术架构演进。</p>
<h2 id="2-0-成长（2012）"><a href="#2-0-成长（2012）" class="headerlink" title="2.0 成长（2012）"></a>2.0 成长（2012）</h2><p>我们刚接手时1.0已在线上运行并支持京东POP（开放平台）业务，之后京东打算组建自营在线客服团队并落地在成都。不管是自营还是POP客服咨询业务当时都起步不久，1.0架构中的性能和效率缺陷问题还没有达到引爆的业务量级。而自营客服当时还处于起步阶段，客服人数不足，服务能力不够，顾客咨询量远远超过客服的服务能力。超出服务能力的顾客咨询，当时我们的系统统一返回提示客服繁忙，请稍后咨询。 这种状况导致高峰期大量顾客无论怎么刷新请求，都很可能无法接入客服，体验很差。所以2.0重点放在了业务功能体验的提升上，如下图所示。<br><img src="/img/京东咚咚2.0.jpg" alt="京东咚咚"><br>京东咚咚针对无法及时提供服务的顾客，可以排队或者留言。 针对纯文字沟通，提供了文件和图片等更丰富的表达方式。 另外支持了客服转接和快捷回复等方式来提升客服的接待效率。总之，整个2.0就是围绕提升客服效率和用户体验。而我们担心的效率问题在2.0高速发展业务的时期还没有出现，但业务量正在逐渐积累，我们知道它快要爆了。到2012年末，度过双十一后开始了3.0的一次重大架构升级。</p>
<h2 id="3-0爆发（2013-–-2014）"><a href="#3-0爆发（2013-–-2014）" class="headerlink" title="3.0爆发（2013 – 2014）"></a>3.0爆发（2013 – 2014）</h2><p>经历了2.0时代一整年的业务高速发展，实际上代码规模膨胀的很快。与代码一块膨胀的还有团队，从最初的4个人到近30人。 团队大了后，一个系统多人开发，开发人员层次不一，规范难统一，系统模块耦合重，改动沟通和依赖多，上线风险难以控制。一个单独tomcat应用多实例部署模型终于走到头了，这个版本架构升级的主题就是服务化。服务化的第一个问题如何把一个大的应用系统切分成子服务系统。当时的背景是京东的部署还在半自动化年代，自动部署系统刚起步，子服务系统若按业务划分太细太多，部署工作量很大且难管理。所以当时我们不是按业务功能分区服务的，而是按业务重要性级别划分了0、1、2 三个级别不同的子业务服务系统。 另外就是独立了一组接入服务，针对不同渠道和通信方式的接入端，见下图。<br><img src="/img/京东咚咚3.0服务化.jpg" alt="京东咚咚"><br>更细化的应用服务和架构分层方式可见下图。<br><img src="/img/京东咚咚3.0细化服务化.jpg" alt="京东咚咚"><br>这次大的架构升级，主要考虑了三个方面：稳定性、效率和容量。 做了下面这些事情：<br>1.业务分级、核心、非核心业务隔离<br>2.多机房部署，流量分流、容灾冗余、峰值应对冗余<br>3.读库多源，失败自动转移<br>4.写库主备，短暂有损服务容忍下的快速切换<br>5.外部接口，失败转移或快速断路<br>6.Redis 主备，失败转移<br>7.大表迁移，MongoDB 取代 MySQL 存储消息记录<br>8.改进消息投递模型</p>
<p>前 6 条基本属于考虑系统稳定性、可用性方面的改进升级。 这一块属于陆续迭代完成的，承载很多失败转移的配置和控制功能在上面图中是由管控中心提供的。 第 7 条主要是随着业务量的上升，单日消息量越来越大后，使用了 MongoDB来单独存储量最大的聊天记录。 第 8 条是针对 1.0版本消息轮询效率低的改进，改进后的投递方式如下图所示：<br><img src="/img/京东咚咚3.0优化轮训服务.jpg" alt="京东咚咚"><br>不再是轮询了，而是让终端每次建立连接后注册接入点位置，消息投递前定位连接所在接入点位置再推送过去。 这样投递效率就是恒定的了，而且很容易扩展，在线人数越多则连接数越多，只需要扩展接入点即可。 其实，这个模型依然还有些小问题，主要出在离线消息的处理上，可以先思考下，我们最后再讲。<br>3.0 经过了两年的迭代式升级，单纯从业务量上来说还可以继续支撑很长时间的增长。 但实际上到 2014 年底我们面对的不再是业务量的问题，而是业务模式的变化。 这直接导致了一个全新时代的到来。<br>4.0 涅槃（2015 至今 )<br>2014 年京东的组织架构发生了很大变化，从一个公司变成了一个集团，下设多个子公司。 原来的商城成为了其中一个子公司，新成立的子公司包括京东金融、京东智能、京东到家、拍拍、海外事业部等。 各自业务范围不同，业务模式也不同，但不管什么业务总是需要客服服务。 如何复用原来为商城量身订做的咚咚客服系统并支持其他子公司业务快速接入成为我们新的课题。<br>最早要求接入的是拍拍网，它是从腾讯收购的，所以是完全不同的账户和订单交易体系。 由于时间紧迫，我们把为商城订做的部分剥离，基于 3.0 架构对接拍拍又单独订做了一套，并独立部署，像下面这样。<br>京东咚咚<br>虽然在业务要求的时间点前完成了上线，但这样做也带来了明显的问题：<br>复制工程，定制业务开发，多套源码维护成本高<br>独立部署，至少双机房主备外加一个灰度集群，资源浪费大<br>以前我们都是面向业务去架构系统，如今新的业务变化形势下我们开始考虑面向平台去架构，在统一平台上跑多套业务，统一源码，统一部署，统一维护。 把业务服务继续拆分，剥离出最基础的 IM 服务，IM 通用服务，客服通用服务，而针对不同的业务特殊需求做最小化的定制服务开发。 部署方式则以平台形式部署，不同的业务方的服务跑在同一个平台上，但数据互相隔离。 服务继续被拆分的更微粒化，形成了一组服务矩阵（见下图）。<br>京东咚咚<br>而部署方式，只需要在双机房建立两套对等集群，并另外建一个较小的灰度发布集群即可，所有不同业务都运行在统一平台集群上，如下图。<br>京东咚咚<br>更细粒度的服务意味着每个服务的开发更简单，代码量更小，依赖更少，隔离稳定性更高。 但更细粒度的服务也意味着更繁琐的运维监控管理，直到今年公司内部弹性私有云、缓存云、消息队列、部署、监控、日志等基础系统日趋完善， 使得实施这类细粒度划分的微服务架构成为可能，运维成本可控。 而从当初 1.0 的 1 种应用进程，到 3.0 的 6、7 种应用进程，再到 4.0 的 50+ 更细粒度的不同种应用进程。 每种进程再根据承载业务流量不同分配不同的实例数，真正的实例进程数会过千。 为了更好的监控和管理这些进程，为此专门定制了一套面向服务的运维管理系统，见下图。<br>京东咚咚<br>统一服务运维提供了实用的内部工具和库来帮助开发更健壮的微服务。 包括中心配置管理，流量埋点监控，数据库和缓存访问，运行时隔离，如下图所示是一个运行隔离的图示：<br>京东咚咚<br>细粒度的微服务做到了进程间隔离，严格的开发规范和工具库帮助实现了异步消息和异步 HTTP 来避免多个跨进程的同步长调用链。 进程内部通过切面方式引入了服务增强容器 Armor 来隔离线程， 并支持进程内的单独业务降级和同步转异步化执行。而所有这些工具和库服务都是为了两个目标：<br>让服务进程运行时状态可见<br>让服务进程运行时状态可被管理和改变<br>最后我们回到前文留下的一个悬念，就是关于消息投递模型的缺陷。 一开始我们在接入层检测到终端连接断开后，消息无法投递，再将消息缓存下来，等终端重连接上来再拉取离线消息。 这个模型在移动时代表现的很不好，因为移动网络的不稳定性，导致经常断链后重连。 而准确的检测网络连接断开是依赖一个网络超时的，导致检测可能不准确，引发消息假投递成功。 新的模型如下图所示，它不再依赖准确的网络连接检测，投递前待确认消息 id 被缓存，而消息体被持久存储。 等到终端接收确认返回后，该消息才算投妥，未确认的消息 id 再重新登陆后或重连接后作为离线消息推送。 这个模型不会产生消息假投妥导致的丢失，但可能导致消息重复，只需由客户终端按消息 id 去重即可。<br>京东咚咚<br>京东咚咚诞生之初正是京东技术转型到 Java 之时，经历这些年的发展，取得了很大的进步。 从草根走向专业，从弱小走向规模，从分散走向统一，从杂乱走向规范。 本文主要重心放在了几年来咚咚架构演进的过程，技术架构单独拿出来看我认为没有绝对的好与不好， 技术架构总是要放在彼时的背景下来看，要考虑业务的时效价值、团队的规模和能力、环境基础设施等等方面。 架构演进的生命周期适时匹配好业务的生命周期，才可能发挥最好的效果。</p>
<p>【编辑推荐】<br>58同城沈剑：好的架构不是设计出来的，而是演进出来的<br>架构必备：Rate limiting 的作用和常见方式<br>京东11.11：商品搜索系统架构设计解密<br>京东唐志雄：从技术角度看白条资产证券化<br>关于Java应用相关不同产品的架构<br>中小型网站架构分析及优化<br>友盟吴磊：移动大数据平台的架构、实践与数据增值<br>【责任编辑：wangxueyan TEL：（010）68476606】</p>
<p>点赞 0<br>架构师  京东  架构分享:<br>内容点评已有0条评论,0次赞还可以输入500字</p>
<p>请输入你的评论<br>提交您还没有登录！请先 登录 或 注册<br>还没有评论内容<br>大家都在看猜你喜欢<br>紧急预警！Struts2新漏洞S2-045来袭，多个版本受影响紧急预警！Struts2新漏洞S2-045来袭，多个版本受影响2017年，为何过半的大数据项目不成功?2017年，为何过半的大数据项目不成功?2017年3月编程语言排行榜：Swift首次进入前十2017年3月编程语言排行榜：Swift首次进入前十如何禁掉Windows 10上的所有广告如何禁掉Windows 10上的所有广告<br>编辑推荐外电iOS与Android设备到底是如何被入侵的？头条HTML5游戏开发难点之效率、性能和加载量头条你所不了解的移动支付背后的技术支撑外电我们为何很难对超大规模应用与分布式架构进行备份？头条2017年3月编程语言排行榜：Swift首次进入前十<br>24H热文一周话题本月最赞<br>5个强大的Java分布式缓存框架推荐<br>坐在马桶上看算法：快速排序<br>Java程序员新手老手都离不开八大开发工具<br>2017年3月编程语言排行榜：Swift首次进入前十<br>多图详解Spring框架的设计理念与设计模式<br>2015年十五个热门的 PHP 开发工具<br>Java 中常用缓存Cache机制的实现<br>浅谈Java中的Set、List、Map的区别<br>视频课程+更多技术大咖的旅游梦：同程CTO结缘腾讯云<br>技术大咖的旅游梦：同程CTO结缘腾讯云<br>讲师：腾讯云1人学习过<br>软考网络工程师考试之IP地址计算轻松解决视频课程（攻克要塞系列）<br>软考网络工程师考试之IP地址计算轻松解决视频<br>讲师：朱小平30人学习过<br>大数据培训班4期培训班课程（只针对培训班学员）<br>大数据培训班4期培训班课程（只针对培训班学<br>讲师：徐培成0人学习过<br>热门职位+更多<br>后端开发<br>全职/1-3年/大专5k-15k分享<br>中级Java工程师<br>全职/1-3年/大专6k-10k高达软件<br>诚聘PHP开发师<br>兼职/5-10年/不限15k-25k慧都科技<br>PHP研发工程师<br>全职/1-3年/本科10k-15k动视云科技<br>后端开发(PHP/Go)<br>全职/5-10年/本科30k-50k瓜子二手车<br>最新专题+更多金三银四跳槽季 开发者这样惊呆你的面试官金三银四跳槽季 开发者这样惊呆你的面试官<br>跳槽季<br>你了解AJAX吗？TA不是新编程语言而是WEB应用程序技术你了解AJAX吗？TA不是新编程语言而是WEB应用程序技术<br>AJAX<br>Web前端知识杂乱 如何分清主次和学习优先级？Web前端知识杂乱 如何分清主次和学习优先级？<br>Web前端/分清主次/学习<br>编程初学者学什么语言好？未来编程趋势预测编程初学者学什么语言好？未来编程趋势预测<br>编程<br>精彩评论<br>和气高尚评论了：【51CTO学院】免费直播课 | 赵海兵–虚拟化与混合云<br>期待中。。。！</p>
<p>lwt1309108评论了：【51CTO学院】免费直播课 | 赵海兵–虚拟化与混合云<br>期待</p>
<p>ashely冰雪雨露评论了：【51CTO学院】免费直播课 | 赵海兵–虚拟化与混合云<br>虚拟化对我目前的工作很要紧</p>
<p>Wanglican评论了：【51CTO学院】团购第二期-低至6折！名师中高级实战进阶项目<br>交了押金了，申请进群了，麻烦通过一下。亲~~<br>精选博文论坛热帖下载排行<br>现阶段为开放式基金赎回良机<br>SecureCRT 使用技巧<br>nagios全攻略(二)—-基本安装和配置<br>关于51CTO合作出书中的职业发展部分<br>利用WINDOWS SERVER 2003路由设置解<br>读 书 +更多<br>点石成金：访客至上的网页设计秘笈（原书第2版）<br>有些网站看起来很清爽； 有些网站看起来很杂乱； 有些网站能让你轻松地找到资料； 有些网站让你犹如置身迷宫…… …</p>
<p>订阅51CTO邮刊<br>点击这里查看样刊<br>订阅51CTO邮刊<br>51CTO旗下网站：领先的IT技术网站 51CTO|领先的中文存储媒体 WatchStor| 中国首个CIO网站 CIOage |中国首家数字医疗网站 HC3i<br>Copyright©2005-2017 51CTO.COM 版权所有 未经许可 请勿转载</p>
]]></content>
    
    <summary type="html">
    
      架构师必看 京东咚咚架构演进
    
    </summary>
    
      <category term="架构" scheme="http://jishusuishouji.github.io/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="架构" scheme="http://jishusuishouji.github.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>VAGRANT 和 Docker的使用场景和区别?</title>
    <link href="http://jishusuishouji.github.io/2017/01/25/xunihua/VAGRANT_%E5%92%8C_Docker%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E5%92%8C%E5%8C%BA%E5%88%AB_/"/>
    <id>http://jishusuishouji.github.io/2017/01/25/xunihua/VAGRANT_和_Docker的使用场景和区别_/</id>
    <published>2017-01-25T06:20:57.000Z</published>
    <updated>2017-01-25T06:25:44.037Z</updated>
    
    <content type="html"><![CDATA[<p>本质区别<br>Vagrant并不提供虚拟化技术，本质上是一个虚拟机外挂，通过虚拟机的管理接口来管理虚拟机，让用户更轻松的进行一些常用配置，比如：CPU/Memory/IP/DISK等分配。并且提供了一些其它的管理操作：比如开机运行指定命令，镜像二次打包，插件编写等等。<br>vagrant官方有介绍:</p>
<blockquote>
<p>To achieve its magic, Vagrant stands on the shoulders of giants. Machines are provisioned on top of VirtualBox, VMware, AWS, or any other provider. Then, industry-standard provisioning tools such as shell scripts, Chef, or Puppet, can be used to automatically install and configure software on the machine.</p>
</blockquote>
<p>而docker是一个容器引擎，每一个实例是一个相对隔离的空间，与宿主机共享操作系统内核，并且共享宿主机资源。相对于披着虚拟机皮的vagrant，docker更加轻量，消耗更少的资源。</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>关于应用场景没有绝对，把两个东西都用熟，自己觉得用哪个方便用哪个好管理就用哪个。既然vagrant本质是虚拟机外挂，那么它的应用场景就是，节省你用原生虚拟机管理软件的时间。原来我们新增一台虚拟机需要配置好内存、硬盘、CPU等，然后添加iso，安装。创建用户，等等。一套下来好几十分钟是吧？聪明点你可能会想到复制一个创建好的镜像然后粘贴。但这一切vagrant都帮你想好了,安装vagrant后你只需要6步就能创建一台新的虚拟机，其中两步是创建文件夹和切换文件夹。<br>从安装到创建一台新的虚拟机就成功了。如果你想要再添加一台虚拟机，你只需要执行最后两步，添加一个不同名字的配置就能再新建一台虚拟机。还支持镜像、开机自动运行脚本、插件编写等。dockerdocker主要应用于解决环境依赖以及为应用程序提供一个相对隔离的空间，一个实例像操作系统里运行的一个程序。原来部署一套环境是不是得自己编写自动化部署依赖环境以及程序的脚本？如果有两个依赖同一程序或库的不同版本怎么办？绝对路径？软连接？docker能很好的解决你的烦恼。把需要的依赖环境打包成一个镜像，再把程序放镜像里面运行。</p>
<p>总的来说vagrant更适合给开发大爷们创造一个统一的开发、测试、接近于完全隔离的环境，以及提高对高配机的闲置利用。docker更方便地解决了同一机器上的环境隔离，以及提高运维锅们解决部署时环境依赖的效率。</p>
]]></content>
    
    <summary type="html">
    
      VAGRANT 和 Docker的使用场景和区别?
    
    </summary>
    
      <category term="docker" scheme="http://jishusuishouji.github.io/categories/docker/"/>
    
    
      <category term="docker" scheme="http://jishusuishouji.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>使用 Velocity 模板引擎快速生成代码</title>
    <link href="http://jishusuishouji.github.io/2017/01/22/java/velocity/%E4%BD%BF%E7%94%A8_Velocity_%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81/"/>
    <id>http://jishusuishouji.github.io/2017/01/22/java/velocity/使用_Velocity_模板引擎快速生成代码/</id>
    <published>2017-01-21T23:35:11.000Z</published>
    <updated>2017-01-24T01:04:31.480Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Velocity-模板引擎介绍"><a href="#Velocity-模板引擎介绍" class="headerlink" title="Velocity 模板引擎介绍"></a>Velocity 模板引擎介绍</h2><p>在现今的软件开发过程中，软件开发人员将更多的精力投入在了重复的相似劳动中。特别是在如今特别流行的MVC架构模式中，软件各个层次的功能更加独立，同时代码的相似度也更加高。所以我们需要寻找一种来减少软件开发人员重复劳动的方法，让程序员将更多的精力放在业务逻辑以及其他更加具有创造力的工作上。Velocity这个模板引擎就可以在一定程度上解决这个问题。<br>Velocity是一个基于Java的模板引擎框架，提供的模板语言可以使用在Java中定义的对象和变量上。Velocity是Apache基金会的项目，开发的目标是分离MVC模式中的持久化层和业务层。但是在实际应用过程中，Velocity不仅仅被用在了MVC的架构中，还可以被用在以下一些场景中。</p>
<p>1.Web应用：开发者在不使用JSP的情况下，可以用Velocity让HTML具有动态内容的特性。<br>2.源代码生成：Velocity可以被用来生成Java代码、SQL或者PostScript。有很多开源和商业开发的软件是使用Velocity来开发的。<br>3.自动Email：很多软件的用户注册、密码提醒或者报表都是使用Velocity来自动生成的。使用Velocity可以在文本文件里面生成邮件内容，而不是在Java代码中拼接字符串。<br>4.转换xml：Velocity提供一个叫 Anakia 的ant任务，可以读取XML文件并让它能够被 Velocity模板读取。一个比较普遍的应用是将xdoc文档转换成带样式的HTML文件。</p>
<h2 id="Hello-Velocity"><a href="#Hello-Velocity" class="headerlink" title="Hello Velocity"></a>Hello Velocity</h2><p>和学习所有新的语言或者框架的顺序一样，我们从Hello Velocity开始学习。首先在Velocity的官网上下载最新的发布包，之后使用Eclipse建立普通的Java项目。引入解压包中的 velocity-1.7.jar和lib文件夹下面的jar包。这样我们就可以在项目中使用Velocity了。<br>在做完上面的准备工作之后，就可以新建一个叫<code>HelloVelocity</code>的类，代码如下：</p>
<h3 id="清单-1-HelloVelocity-java"><a href="#清单-1-HelloVelocity-java" class="headerlink" title="清单 1. HelloVelocity.java"></a>清单 1. HelloVelocity.java</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">public class HelloVelocity &#123;</div><div class="line"> public static void main(String[] args) &#123;</div><div class="line"> VelocityEngine ve = new VelocityEngine();</div><div class="line"> ve.setProperty(RuntimeConstants.RESOURCE_LOADER, &quot;classpath&quot;);</div><div class="line"> ve.setProperty(&quot;classpath.resource.loader.class&quot;, ClasspathResourceLoader.class.getName());</div><div class="line"> </div><div class="line"> ve.init();</div><div class="line"> </div><div class="line"> Template t = ve.getTemplate(&quot;hellovelocity.vm&quot;);</div><div class="line"> VelocityContext ctx = new VelocityContext();</div><div class="line"> </div><div class="line"> ctx.put(&quot;name&quot;, &quot;velocity&quot;);</div><div class="line"> ctx.put(&quot;date&quot;, (new Date()).toString());</div><div class="line"> </div><div class="line"> List temp = new ArrayList();</div><div class="line"> temp.add(&quot;1&quot;);</div><div class="line"> temp.add(&quot;2&quot;);</div><div class="line"> ctx.put(&quot;list&quot;, temp);</div><div class="line"> </div><div class="line"> StringWriter sw = new StringWriter();</div><div class="line"> </div><div class="line"> t.merge(ctx, sw);</div><div class="line"> </div><div class="line"> System.out.println(sw.toString());</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在<code>HelloVelocity</code>的代码中，首先<code>new</code>了一个<code>VelocityEngine</code>类，这个类设置了Velocity使用的一些配置，在初始化引擎之后就可以读取<code>hellovelocity.vm</code>这个模板生成的<code>Template</code>这个类。之后的<code>VelocityContext</code>类是配置<code>Velocity</code>模板读取的内容。这个<code>context</code>可以存入任意类型的对象或者变量，让<code>template</code>来读取。这个操作就像是在使用JSP开发时，往<code>request</code>里面放入key-value，让JSP 读取一样。<br>接下来就是写<code>hellovelocity.vm</code>文件了，这个文件实际定义了Velocity的输出内容和格式。<code>hellovelocity.vm</code>的内容如下：</p>
<h3 id="清单-2-Hellovelocity-vm"><a href="#清单-2-Hellovelocity-vm" class="headerlink" title="清单 2. Hellovelocity.vm"></a>清单 2. Hellovelocity.vm</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#set( $iAmVariable = &quot;good!&quot; )</div><div class="line">Welcome $name to velocity.com</div><div class="line">today is $date.</div><div class="line">#foreach ($i in $list)</div><div class="line">$i</div><div class="line">#end</div><div class="line">$iAmVariable</div></pre></td></tr></table></figure>
<p>输出结果如下：<br>Welcome velocity to velocity.com<br>today is Sun Mar 23 19:19:04 CST 2014.<br>1<br>2<br>good!<br>在输出结果中我们可以看到，$name、$date 都被替换成了在 HelloVelocity.java 里面定义的变量，在 foreach 语句里面遍历了 list 的每一个元素，并打印出来。而$iAmVariable 则是在页面中使用 #set 定义的变量。<br>回页首<br>基本模板语言语法使用<br>在 hellovelocity.vm 里面可以看到很多以 # 和$符开头的内容，这些都是 Velocity 的语法。在 Velocity 中所有的关键字都是以 # 开头的，而所有的变量则是以$开头。Velocity 的语法类似于 JSP 中的 JSTL，甚至可以定义类似于函数的宏，下面来看看具体的语法规则。<br>一、变量<br>和我们所熟知的其他编程语言一样，Velocity 也可以在模板文件中有变量的概念。</p>
<ol>
<li>变量定义<br>#set($name =“velocity”)<br>等号后面的字符串 Velocity 引擎将重新解析，例如出现以$开始的字符串时，将做变量的替换。<br>#set($hello =“hello $name”)<br>上面的这个等式将会给$hello 赋值为“hello velocity”</li>
<li>变量的使用<br>在模板文件中使用$name 或者${name} 来使用定义的变量。推荐使用${name} 这种格式，因为在模板中同时可能定义了类似$name 和$names 的两个变量，如果不选用大括号的话，引擎就没有办法正确识别$names 这个变量。<br>对于一个复杂对象类型的变量，例如$person，可以使用${person.name} 来访问 person 的 name 属性。值得注意的是，这里的${person.name} 并不是直接访问 person 的 name 属性，而是访问 person 的 getName() 方法，所以${person.name} 和${person.getName()} 是一样的。</li>
<li>变量赋值<br>在第一小点中，定义了一个变量，同时给这个变量赋了值。对于 Velocity 来说，变量是弱数据类型的，可以在赋了一个 String 给变量之后再赋一个数字或者数组给它。可以将以下六种数据类型赋给一个 Velocity 变量：变量引用, 字面字符串, 属性引用, 方法引用, 字面数字, 数组列表。<br>#set($foo = $bar)<br>#set($foo =“hello”)<br>#set($foo.name = $bar.name)<br>#set($foo.name = $bar.getName($arg))<br>#set($foo = 123)<br>#set($foo = [“foo”,$bar])<br>二、循环<br>在 Velocity 中循环语句的语法结构如下：<br>#foreach($element in $list)<br>This is $element<br>$velocityCount<br>#end<br>Velocity 引擎会将 list 中的值循环赋给 element 变量，同时会创建一个$velocityCount 的变量作为计数，从 1 开始，每次循环都会加 1.<br>三、条件语句<br>条件语句的语法如下<br>#if(condition)<br>…<br>#elseif(condition)<br>…<br>#else<br>…<br>#end<br>四、关系操作符<br>Velocity 引擎提供了 AND、OR 和 NOT 操作符，分别对应&amp;&amp;、||和! 例如：<br>#if($foo &amp;&amp; $bar)<br>#end<br>五、宏<br>Velocity 中的宏可以理解为函数定义。定义的语法如下：<br>#macro(macroName arg1 arg2 …)<br>…<br>#end<br>调用这个宏的语法是：<br>#macroName(arg1 arg2 …)<br>这里的参数之间使用空格隔开，下面是定义和使用 Velocity 宏的例子：<br>#macro(sayHello $name)<br>hello $name<br>#end<br>#sayHello(“velocity”)<br>输出的结果为 hello velocity<br>六、#parse 和 #include<br>#parse 和 #include 指令的功能都是在外部引用文件，而两者的区别是，#parse 会将引用的内容当成类似于源码文件，会将内容在引入的地方进行解析，#include 是将引入文件当成资源文件，会将引入内容原封不动地以文本输出。分别看以下例子：<br>foo.vm 文件：<br>#set($name =“velocity”)<br>parse.vm：<br>#parse(“foo.vm”)<br>输出结果为：velocity<br>include.vm：<br>#include(“foo.vm”)<br>输出结果为：#set($name =“velocity”)<br>以上内容包含了部分 Velocity 的语法，详细的语法内容可以参考 Velocity 的官方文档。<br>回页首<br>自动生成代码的例子<br>在上个例子中我们可以生成任意的字符串并且打印出来，那为什么我们不能生成一些按照既定格式定义的代码并且写入文件呢。<br>在这里我们以一个实际的 demo 来完成这部分内容。相关内容的源码可以参照附件。这个 demo 的功能是要实现一个学生和老师的管理，实际上都是单张表的维护。我们希望能够只定义 model 层，来生成 MVC 的所有代码。在这个 demo 中，只自动生成 action 和 JSP 的内容，因为现在有很多工具都可以帮助我们自动生成这两个包的代码。<br>首先在 eclipse 中建立一个 Java web 工程，在例子中为了方便管理 jar 包，使用的是 maven 来建立和管理工程。建立好的工程目录结构如下图所示：<br>图 1. 项目目录结构<br>项目目录结构<br>Java Resource 中放的是 Java 源码以及资源文件，Deployed Resources 中放的是 web 相关的文件。在 Java 文件中使用了类似 Spring 的 @Component 和 @Autowired 的注解来实现 IoC，使用 @Action 这样的注解实现 MVC，而在 JSP 中则使用了 JSTL 来输出页面。在上图所示的目录中，annotation、filter、framework 和 util 这四个 package 是作为这个项目框架的，跟业务没有关系，类似于 spring 和 struts 的功能。<br>在实际的项目中我们当然希望能够一开始就编写一个通用的模板文件，然后一下子生成所有的代码，但是很多时候这样做是不可能的，或者说比较困难。为了解决这个问题，我们可以在编写 Velocity 模板文件之前先按照原本的流程编写代码，暂时先忘掉 Velocity。编写的代码应该能够在一个功能上完整的调通涉及 MVC 中所有层次的内容。在这个例子中，先编写好 StudentAction.java 文件，以及上图中 webapp 目录中所示的文件。在写好以上代码，同时也能顺利运行之后，我们可以参照之前编写的代码来写模板文件。这里我们来分别看一个 Java 文件和 JSP 的例子。<br>清单 3. ActionTemplate.vm<br>#parse (“macro.vm”)</li>
</ol>
<p>@Action(“${classNameLowCase}Action”)<br>public class ${classNameUpCase}Action extends BaseAction{<br> @Autowired<br> public ${classNameUpCase}Dao ${classNameLowCase}Dao;<br> private List&lt;${classNameUpCase}&gt; ${classNameLowCase}s;<br> private ${classNameUpCase} ${classNameLowCase};</p>
<p>#foreach ($attr in ${attrs})<br> private ${attr[0]} ${attr[1]};</p>
<p>#end<br> public String ${classNameLowCase}List() {<br> ${classNameLowCase}s = ${classNameLowCase}Dao.retrieveAll${classNameUpCase}s();<br> return “${classNameLowCase}List.jsp”;<br> }</p>
<p> …<br>}<br>上面的代码展示了一个 Java 类转换成 vm 模板之后的部分内容，完整内容请参考附件。<br>macro.vm 文件中定义了一些使用的宏。JSP 的改造相对于 Java 文件来说稍微有点复杂，因为 JSP 中使用 JSTL 取 request 中的值也是使用${name} 这样的语法，所以想要输出${name} 这样的字符串而不是被模板引擎所替换，则需要使用转义字符，就像这样：\${name}。<br>为了能够让这个文件中的 table 得到复用，我们将这个文件中的表格单独拿出来，使用 #parse 命令来包含。下面是 ListJspTemplate.vm 和 ListTableTemplate.vm 的内容：<br>清单 4. ListJspTemplate.vm<br>&lt;%@ page language=”java” contentType=”text/html; charset=UTF-8”<br> pageEncoding=”UTF-8”%&gt;<br>&lt;%@taglib prefix=”c” uri=”<a href="http://java.sun.com/jsp/jstl/core" target="_blank" rel="external">http://java.sun.com/jsp/jstl/core</a>“ %&gt;<br>&lt;!DOCTYPE html PUBLIC “-//W3C//DTD HTML 4.01 Transitional//EN” “<a href="http://www.w3.org/TR/html4/loose.dtd&quot;&gt;" target="_blank" rel="external">http://www.w3.org/TR/html4/loose.dtd&quot;&gt;</a></p>
<p><html></html></p>
<p><head><br> &lt;%@ include file=”includeJS.jsp” %&gt;<br> <script type="text/javascript"><br> var pageConfig = {<br> “list” : {<br> “action” : “${classNameLowCase}Action!${classNameLowCase}List.action”<br> }<br> …<br> “idName” : “${classNameLowCase}Id”<br> };<br> </script><br> <script type="text/javascript" src="common.js"></script></head></p>
<p><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></p>
<p><title>${classNameUpCase} List</title><br></p>
<p><body></body></p>
<p></p><h1>${classNameUpCase} List</h1><p></p>
<p><div><button id="addButton">Add</button></div></p>
<p>#parse (“ListTableTemplate.vm”)</p>
<p><div id="modifyDiv"></div></p>
<p><div id="addDiv"></div><br><br><br>清单 5. ListTableTemplate.vm</p>
<p>#parse (“macro.vm”)</p>
<p>#set($plus = “status.index+1”)</p>
<p><table border="1" style="width: 100%"><br> <thead><br> <tr><th>No.</th>#generateTH($attrs)</tr><br> </thead><br> <tbody><br> <c:foreach var="${classNameLowCase}" items="${${classNameLowCase}s }" varstatus="status"><br> <tr ${classnamelowcase}id="${${classNameLowCase}.id }"><br> <td>${${plus}}</td>#generateTD($classNameLowCase $attrs)<td><br> <button class="modifyButton">Modify</button><br> <button class="deleteButton">Delete</button></td></tr><br> </c:foreach><br> </tbody><br></table><br>在定义好所有的模板文件之后，需要做的是读取这些文件，然后根据这些文件将 model 的数据类型以及名称设置到 context 中，最后将解析出来的内容写到相应的目录中去。这些工作我们放在了一个叫做 VelocityGenerator 的类中来做，它的源码如下：<br>清单 6. TemplateGenerator.java<br>public class VelocityGenerator {</p>
<p> public static void main(String[] args) {<br> VelocityEngine ve = new VelocityEngine();<br> ve.setProperty(RuntimeConstants.RESOURCE_LOADER, “classpath”);<br> ve.setProperty(“classpath.resource.loader.class”, ClasspathResourceLoader.class.getName());</p>
<p> ve.init();<br> Template actionTpt = ve.getTemplate(“ActionTemplate.vm”);<br> Template listJspTpt = ve.getTemplate(“ListJspTemplate.vm”);<br> Template addTpt = ve.getTemplate(“AddTemplate.vm”);<br> Template modifyTpt = ve.getTemplate(“ModifyTemplate.vm”);<br> VelocityContext ctx = new VelocityContext();</p>
<p> ctx.put(“classNameLowCase”, “teacher”);<br> ctx.put(“classNameUpCase”, “Teacher”);<br> String[][] attrs = {<br> {“Integer”,”id”},<br> {“String”,”name”},<br> {“String”,”serializeNo”},<br> {“String”,”titile”},<br> {“String”,”subject”}<br> };<br> ctx.put(“attrs”, attrs);<br> String rootPath = VelocityGenerator.class.getClassLoader().getResource(“”).getFile() + “../../src/main”;<br> merge(actionTpt,ctx,rootPath+”/java/com/liuxiang/velocity/action/TeacherAction.java”);<br> merge(listJspTpt,ctx,rootPath+”/webapp/teacherList.jsp”);<br> merge(addTpt,ctx,rootPath+”/webapp/teacherAdd.jsp”);<br> merge(modifyTpt,ctx,rootPath+”/webapp/teacherModify.jsp”);<br> System.out.println(“success…”);<br> }</p>
<p> private static void merge(Template template, VelocityContext ctx, String path) {<br> PrintWriter writer = null;<br> try {<br> writer = new PrintWriter(path);<br> template.merge(ctx, writer);<br> writer.flush();<br> } catch (FileNotFoundException e) {<br> e.printStackTrace();<br> } finally {<br> writer.close();<br> }<br> }<br>}<br>在运行以上代码之后，项目文件夹中将会出现与 Teacher 相关的代码文件。<br>在实际项目中可能不会出现很多这种单张表维护的情况，而且业务逻辑和系统架构会更加复杂，编写模板文件就更加不容易。但是无论多复杂的系统，不同的业务逻辑之间一定或多或少会有相似的代码，特别是在 JSP 和 JS 显示端文件中，因为我们在一个系统中要求显示风格、操作方式一致的时候就免不了会有相似内容的代码出现。在总结这些相似性之后我们还是可以使用 Velocity 来帮助我们生成部分内容的代码，而且即使有一些非共性的内容，我们也可以在生成的代码中继续修改。使用 Velocity 的另外一个好处是生成出来的代码更好维护，风格更加统一。<br>回页首<br>结束语<br>Velocity 可以被应用在各种各样的情景下，本文介绍的只是它的一种用途而已，它还可以被用来做 MVC 结构中的 view 层，或者动态内容静态化等。另外，Velocity 并不是唯一的模板框架，同样很优秀的 Freemarker 也获得了非常广泛的应用，有兴趣的读者可以去深入研究更多的功能和用途。</p>
]]></content>
    
    <summary type="html">
    
      使用 Velocity 模板引擎快速生成代码
    
    </summary>
    
      <category term="Velocity" scheme="http://jishusuishouji.github.io/categories/Velocity/"/>
    
    
      <category term="Velocity" scheme="http://jishusuishouji.github.io/tags/Velocity/"/>
    
  </entry>
  
  <entry>
    <title>Spring中提示元素 &#39;ref&#39; 中不允许出现属性 &#39;local&#39;</title>
    <link href="http://jishusuishouji.github.io/2017/01/17/spring/Spring%E4%B8%AD%E6%8F%90%E7%A4%BA%E5%85%83%E7%B4%A0__ref__%E4%B8%AD%E4%B8%8D%E5%85%81%E8%AE%B8%E5%87%BA%E7%8E%B0%E5%B1%9E%E6%80%A7__local_/"/>
    <id>http://jishusuishouji.github.io/2017/01/17/spring/Spring中提示元素__ref__中不允许出现属性__local_/</id>
    <published>2017-01-17T07:58:44.000Z</published>
    <updated>2017-01-17T08:00:23.520Z</updated>
    
    <content type="html"><![CDATA[<p>这个问题在Spring4.X以前的版本不存在。通过查询Spring的官方文档Spring4.X的以上版本不支持该属性了。<br>下面是官方说明：</p>
<blockquote>
<p>The local attribute on the ref element is no longer supported in the 4.0 beans xsd since it does not provide value over a regular bean reference anymore. Simply change your existing ref local references to ref bean when upgrading to the 4.0 schema. </p>
</blockquote>
<p>官方建议使用bean在Spring4.0以上的版本。</p>
<h2 id="案例重现"><a href="#案例重现" class="headerlink" title="案例重现"></a>案例重现</h2><h3 id="抛错："><a href="#抛错：" class="headerlink" title="抛错："></a>抛错：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">Exception in thread &quot;main&quot; org.springframework.beans.factory.xml.XmlBeanDefinitionStoreException: Line 37 in XML document from class path resource [application_dependencies.xml] is invalid; nested exception is org.xml.sax.SAXParseException; lineNumber: 37; columnNumber: 27; cvc-complex-type.3.2.2: 元素 &apos;ref&apos; 中不允许出现属性 &apos;local&apos;。</div><div class="line">    at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.doLoadBeanDefinitions(XmlBeanDefinitionReader.java:399)</div><div class="line">    at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.loadBeanDefinitions(XmlBeanDefinitionReader.java:336)</div><div class="line">    at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.loadBeanDefinitions(XmlBeanDefinitionReader.java:304)</div><div class="line">    at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:181)</div><div class="line">    at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:217)</div><div class="line">    at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:188)</div><div class="line">    at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:252)</div><div class="line">    at org.springframework.context.support.AbstractXmlApplicationContext.loadBeanDefinitions(AbstractXmlApplicationContext.java:127)</div><div class="line">    at org.springframework.context.support.AbstractXmlApplicationContext.loadBeanDefinitions(AbstractXmlApplicationContext.java:93)</div><div class="line">    at org.springframework.context.support.AbstractRefreshableApplicationContext.refreshBeanFactory(AbstractRefreshableApplicationContext.java:129)</div><div class="line">    at org.springframework.context.support.AbstractApplicationContext.obtainFreshBeanFactory(AbstractApplicationContext.java:604)</div><div class="line">    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:509)</div><div class="line">    at org.springframework.context.support.ClassPathXmlApplicationContext.&lt;init&gt;(ClassPathXmlApplicationContext.java:139)</div><div class="line">    at org.springframework.context.support.ClassPathXmlApplicationContext.&lt;init&gt;(ClassPathXmlApplicationContext.java:83)</div><div class="line">    at com.mxsm.spring.SpringDependencies.main(SpringDependencies.java:64)</div><div class="line">Caused by: org.xml.sax.SAXParseException; lineNumber: 37; columnNumber: 27; cvc-complex-type.3.2.2: 元素 &apos;ref&apos; 中不允许出现属性 &apos;local&apos;。</div><div class="line">    at com.sun.org.apache.xerces.internal.util.ErrorHandlerWrapper.createSAXParseException(ErrorHandlerWrapper.java:198)</div><div class="line">    at com.sun.org.apache.xerces.internal.util.ErrorHandlerWrapper.error(ErrorHandlerWrapper.java:134)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.XMLErrorReporter.reportError(XMLErrorReporter.java:437)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.XMLErrorReporter.reportError(XMLErrorReporter.java:368)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.XMLErrorReporter.reportError(XMLErrorReporter.java:325)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator$XSIErrorReporter.reportError(XMLSchemaValidator.java:453)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator.reportSchemaError(XMLSchemaValidator.java:3232)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator.processAttributes(XMLSchemaValidator.java:2709)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator.handleStartElement(XMLSchemaValidator.java:2051)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator.emptyElement(XMLSchemaValidator.java:761)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.XMLNSDocumentScannerImpl.scanStartElement(XMLNSDocumentScannerImpl.java:353)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDriver.next(XMLDocumentFragmentScannerImpl.java:2717)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.XMLDocumentScannerImpl.next(XMLDocumentScannerImpl.java:607)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.XMLNSDocumentScannerImpl.next(XMLNSDocumentScannerImpl.java:116)</div><div class="line">    at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:489)</div><div class="line">    at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:835)</div><div class="line">    at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:764)</div><div class="line">    at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:123)</div><div class="line">    at com.sun.org.apache.xerces.internal.parsers.DOMParser.parse(DOMParser.java:237)</div><div class="line">    at com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderImpl.parse(DocumentBuilderImpl.java:300)</div><div class="line">    at org.springframework.beans.factory.xml.DefaultDocumentLoader.loadDocument(DefaultDocumentLoader.java:76)</div><div class="line">    at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.doLoadDocument(XmlBeanDefinitionReader.java:429)</div><div class="line">    at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.doLoadBeanDefinitions(XmlBeanDefinitionReader.java:391)</div><div class="line">    ... 14 more</div></pre></td></tr></table></figure>
<h3 id="spring-xml文件配置"><a href="#spring-xml文件配置" class="headerlink" title="spring xml文件配置"></a>spring xml文件配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</div><div class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</div><div class="line"></div><div class="line">    &lt;bean id=&quot;animals&quot; class=&quot;com.mxsm.spring.bean.Animal&quot;&gt;</div><div class="line">        &lt;constructor-arg&gt;</div><div class="line">            &lt;ref bean=&quot;dog&quot;/&gt;</div><div class="line">        &lt;/constructor-arg&gt;</div><div class="line">        &lt;constructor-arg&gt;</div><div class="line">            &lt;ref bean=&quot;cat&quot;/&gt;</div><div class="line">        &lt;/constructor-arg&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line"></div><div class="line">    &lt;!--使用type属性--&gt;</div><div class="line">    &lt;bean id=&quot;dog&quot; class=&quot;com.mxsm.spring.bean.Dog&quot;&gt;</div><div class="line">        &lt;constructor-arg  type=&quot;java.lang.String&quot; value=&quot;aa&quot;/&gt;</div><div class="line">        &lt;constructor-arg  type=&quot;int&quot; value=&quot;1&quot;/&gt;</div><div class="line">        &lt;constructor-arg  type=&quot;java.lang.String&quot; value=&quot;meat&quot;/&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line"></div><div class="line">    &lt;bean id=&quot;dog_2&quot; class=&quot;com.mxsm.spring.bean.Dog&quot;&gt;</div><div class="line">        &lt;constructor-arg index=&quot;0&quot; value=&quot;ssss&quot;/&gt;</div><div class="line">        &lt;constructor-arg index=&quot;1&quot; value=&quot;3333&quot;/&gt;</div><div class="line">        &lt;constructor-arg index=&quot;2&quot; value=&quot;8888&quot;/&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line"></div><div class="line">    &lt;bean id=&quot;cat&quot; class=&quot;com.mxsm.spring.bean.Cat&quot;&gt;</div><div class="line">        &lt;constructor-arg name=&quot;a&quot; value=&quot;ssss&quot;/&gt;</div><div class="line">        &lt;constructor-arg name=&quot;b&quot; value=&quot;3333&quot;/&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line"></div><div class="line">    &lt;!-- setter 依赖注入bean --&gt;</div><div class="line">    **&lt;bean id=&quot;man&quot; class=&quot;com.mxsm.spring.bean.Man&quot;&gt;</div><div class="line">        &lt;property name=&quot;white&quot;&gt;</div><div class="line">            &lt;ref local=&quot;whiteMan&quot;/&gt;</div><div class="line">        &lt;/property&gt;</div><div class="line"></div><div class="line">        &lt;property name=&quot;yellow&quot;&gt;</div><div class="line">            &lt;ref local =&quot;yellowMan&quot;/&gt;</div><div class="line">        &lt;/property&gt;</div><div class="line"></div><div class="line">        &lt;property name=&quot;id&quot; value=&quot;1&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;/bean&gt;**</div><div class="line"></div><div class="line">    &lt;bean id=&quot;whiteMan&quot; class=&quot;com.mxsm.spring.bean.WhitePerson&quot;&gt;</div><div class="line">        &lt;constructor-arg name=&quot;age&quot; value=&quot;1&quot;/&gt;</div><div class="line">        &lt;constructor-arg name=&quot;color&quot; value=&quot;white&quot;/&gt;</div><div class="line">        &lt;constructor-arg name=&quot;name&quot; value=&quot;USA&quot;/&gt;</div><div class="line">        &lt;constructor-arg name=&quot;sex&quot; value=&quot;男&quot;/&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line"></div><div class="line">    &lt;bean id=&quot;yellowMan&quot; class=&quot;com.mxsm.spring.bean.YellowPerson&quot;&gt;</div><div class="line">        &lt;constructor-arg name=&quot;age&quot; value=&quot;1&quot;/&gt;</div><div class="line">        &lt;constructor-arg name=&quot;color&quot; value=&quot;yellow&quot;/&gt;</div><div class="line">        &lt;constructor-arg name=&quot;name&quot; value=&quot;China&quot;/&gt;</div><div class="line">        &lt;constructor-arg name=&quot;sex&quot; value=&quot;男&quot;/&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line"></div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Spring中提示元素 &#39;ref&#39; 中不允许出现属性 &#39;local&#39;
    
    </summary>
    
      <category term="spring" scheme="http://jishusuishouji.github.io/categories/spring/"/>
    
    
      <category term="spring" scheme="http://jishusuishouji.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>nodejs的require模块及路径</title>
    <link href="http://jishusuishouji.github.io/2017/01/14/nodejs/nodejs%E7%9A%84require%E6%A8%A1%E5%9D%97%E5%8F%8A%E8%B7%AF%E5%BE%84/"/>
    <id>http://jishusuishouji.github.io/2017/01/14/nodejs/nodejs的require模块及路径/</id>
    <published>2017-01-13T17:30:53.000Z</published>
    <updated>2017-01-13T17:38:42.287Z</updated>
    
    <content type="html"><![CDATA[<p>在nodejs中，模块分为核心模块和文件模块。    </p>
<p>核心模块是被编译成二进制代码，引用的时候只需<code>require</code>即可，如<code>require(&#39;net&#39;)</code>。<br>文件模块，则是指js文件、json文件或者是.node文件。在引用文件模块的时候要加上文件的路径：如果既不加<code>/.../...</code>、<code>../</code>又不加<code>./</code>的话，则该模块要么是核心模块，要么是从一个<code>node_modules</code>文件夹加载。</p>
<p>如果’<code>/home/ry/projects/foo.js</code>‘ 中的文件调用了`require(‘bar.js’)`` ，node将在下面的位置进行搜索：</p>
<p>•<code>/home/ry/projects/node_modules/bar.js</code><br>•<code>/home/ry/node_modules/bar.js</code><br>•<code>/home/node_modules/bar.js</code><br>•<code>/node_modules/bar.js</code></p>
<h2 id="文件夹作为模块："><a href="#文件夹作为模块：" class="headerlink" title="文件夹作为模块："></a>文件夹作为模块：</h2><p>首先在<code>./some-library</code>文件夹下建立<code>package.json</code>文件，它标识了一个主模块。一个<code>package.json</code>中的内容可能如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123; </div><div class="line">    &quot;name&quot; : &quot;some-library&quot;,  </div><div class="line">    &quot;main&quot; : &quot;./lib/some-library.js&quot; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>require(&#39;./some-library&#39;)</code>(和some-library相同路径的js文件)时将试图加载<code>./some-library/lib/some-library.js</code><br>如果在这个目录下没有<code>package.json</code>文件，node将试图从这个目录下加载<code>index.js</code>或<code>index.node</code>文件。例如，如果上面没有<code>package.json</code>文件，那么<code>require(&#39;./some-library&#39;)</code>时，将试图加载下面的文件：<br>•<code>./some-library/index.js</code><br>•<code>./some-library/index.node</code></p>
<p>分类: javascript,nodejs<br>标签: javascript, nodejs</p>
]]></content>
    
    <summary type="html">
    
      nodejs的require模块及路径
    
    </summary>
    
      <category term="nodejs" scheme="http://jishusuishouji.github.io/categories/nodejs/"/>
    
    
      <category term="nodejs" scheme="http://jishusuishouji.github.io/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>Spring MVC事务配置</title>
    <link href="http://jishusuishouji.github.io/2017/01/09/java/spring/Spring_MVC%E4%BA%8B%E5%8A%A1%E9%85%8D%E7%BD%AE/"/>
    <id>http://jishusuishouji.github.io/2017/01/09/java/spring/Spring_MVC事务配置/</id>
    <published>2017-01-09T14:36:01.000Z</published>
    <updated>2017-01-09T14:36:01.677Z</updated>
    
    <summary type="html">
    
      Spring MVC事务配置
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>是该抛弃Spring HibernateTemplate的时候了</title>
    <link href="http://jishusuishouji.github.io/2017/01/09/java/spring/%E6%98%AF%E8%AF%A5%E6%8A%9B%E5%BC%83Spring_HibernateTemplate%E7%9A%84%E6%97%B6%E5%80%99%E4%BA%86/"/>
    <id>http://jishusuishouji.github.io/2017/01/09/java/spring/是该抛弃Spring_HibernateTemplate的时候了/</id>
    <published>2017-01-09T14:26:48.000Z</published>
    <updated>2017-01-09T14:34:52.368Z</updated>
    
    <content type="html"><![CDATA[<p>在spring2.0之前，我们在使用hibernate和spring的时候，都会被<code>HibernateTemplate</code>为我们提供benefits（资源和事务管理以及把那个“丑陋”的checked exception转换为runtime exception-DataAccessException ）而折服，在项目中不由自主、不假思索地使用它和那个经典的callback方法。而如今，hibernate3.0.1+ 、spring 2.0+版本以后，我们可以在数据访问层直接使用hinberate的session API(例如<code>SessionFactory.getCurrentSession</code>)，不并担心session和transaction management。至于error handling可以通过spring的@Repository annotation和post processor-PersistenceExceptionTranslationPostProcessor来解决。让我们来看一些代码片段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;sessionFactory&quot; class=&quot;org.springframework.orm.hibernate3.  </div><div class="line">LocalSessionFactoryBean&quot;&gt;  </div><div class="line">&lt;!-- the properties setting--&gt;  </div><div class="line">&lt;/bean&gt;  </div><div class="line">   </div><div class="line">&lt;bean id=&quot;accountRepo&quot; class=&quot;com.mycompany.HibernateAccountRepository&quot;&gt;  </div><div class="line">    &lt;constructor-arg ref=&quot;sessionFactory&quot;&gt;&lt;/constructor-arg&gt;  </div><div class="line">&lt;/bean&gt;  </div><div class="line">&lt;bean class=&quot;org.springframework.dao.annotation. PersistenceExceptionTranslationPostProcessor&quot;/&gt;</div></pre></td></tr></table></figure></p>
<p>数据访问层代码片段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@Repository  </div><div class="line">public class HibernateAccountRepository implements AccountRepository &#123;  </div><div class="line">   </div><div class="line">    private SessionFactory factory;  </div><div class="line">   </div><div class="line">    public HibernateAccountRepository(SessionFactory factory) &#123;  </div><div class="line">        this.factory = factory;  </div><div class="line">    &#125;  </div><div class="line">   </div><div class="line">    public Account loadAccount(String username) &#123;  </div><div class="line">        return (Account)factory.getCurrentSession()</div><div class="line">                  .createQuery(&quot;from Account acc where acc.name = :name&quot;)  </div><div class="line">                  .setParameter(&quot;name&quot;, &quot;thethirdpart&quot;).uniqueResult();  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在xml配置文件里面通过配置的post processor会自动检测<code>@Repository</code>标注的bean并为该bean打开exception转换功能。    </p>
<p>如果不支持annotations，可以通过AOP来实现，更方便<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;persistenceExceptionInterceptor&quot;  </div><div class="line">class=&quot;org.springframework.dao.support.PersistenceExceptionTranslationInterceptor&quot;/&gt;  </div><div class="line">&lt;aop:config&gt;  </div><div class="line">    &lt;aop:advisor pointcut=&quot;execution(* *..*Repository+.*(..))&quot;  </div><div class="line">                          advice-ref=&quot;persistenceExceptionInterceptor&quot; /&gt;  </div><div class="line">&lt;/aop:config&gt;</div></pre></td></tr></table></figure></p>
<p>总结，我们应该选择哪种方式呢？还是那句话，根据不同的情况来做最正确的选择。但我建议是丢弃template，而直接使用hibernate的API，毕竟灵活性更大，更何况遇到复杂的情况我们始终得面对hibernate的API。spring并不强制你做任何事情，记得它是一个非侵入性的framework。</p>
]]></content>
    
    <summary type="html">
    
      是该抛弃Spring HibernateTemplate的时候了
    
    </summary>
    
      <category term="java" scheme="http://jishusuishouji.github.io/categories/java/"/>
    
    
      <category term="spring" scheme="http://jishusuishouji.github.io/tags/spring/"/>
    
      <category term="java" scheme="http://jishusuishouji.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>So should you still use Spring&#39;s HibernateTemplate and/or JpaTemplate??</title>
    <link href="http://jishusuishouji.github.io/2017/01/09/java/spring/So_should_you_still_use_Spring_s_HibernateTemplate_and_or_JpaTemplate__/"/>
    <id>http://jishusuishouji.github.io/2017/01/09/java/spring/So_should_you_still_use_Spring_s_HibernateTemplate_and_or_JpaTemplate__/</id>
    <published>2017-01-09T14:20:51.000Z</published>
    <updated>2017-01-09T14:46:04.037Z</updated>
    
    <content type="html"><![CDATA[<p>I was reading <a href="http://www.infoq.com/articles/dynamic-routing-using-spring" target="_blank" rel="external">an article by Vigil Bose</a> on TSS the other day and saw the usage of the <code>HibernateDaoSupport</code> class. Since this is no longer a recommended way of using Hibernate from Spring, I thought I might as well just blog about it another time.   </p>
<p>不建议使用<code>HibernateDaoSupport</code>。   </p>
<p>With the advent(n. 到来；出现；) of Spring 2.0, it has become possible to start using the Hibernate Session API directly again. The question is whether or not it is wise to abandon the use of the <code>HibernateTemplate</code> when working with Hibernate, or any other template-based approaches Spring features.  </p>
<h2 id="Using-Spring-XxxTemplates"><a href="#Using-Spring-XxxTemplates" class="headerlink" title="Using Spring XxxTemplates"></a>Using Spring XxxTemplates</h2><p>In Spring 1.0, we introduced a revolutionary way of working with data access APIs that threw checked exceptions. The template approach Spring features along with its transaction synchronization manager and the extensive(adj. 广泛的；大量的；广阔的) use of runtime exceptions makes any TCFTC (short for try/catch-finally-try/catch as we coined(杜撰) it back in 2005) often found in data access code entirely obsolete. Below you can see (a simplified version and not entirely precise version of) what Spring’s template approach does for you (with specific code snippets that you would otherwise have to write).</p>
<p><strong>Acquisition of connection</strong>: If transaction synchronization is active (which it is, if you’re using Spring’s transaction management infrastructure), most of the times any of the Spring templates are using the same connection across the entire thread (things are actually a bit more complicated than that, but that would lead us too much into the gory details).   </p>
<p><strong>Participation in a transaction</strong> Again, when using transaction management features, Spring will automatically associated any new connection with the current transaction. This again, all depends on the current propagations settings and so on, but whichever way you look at it, your core code is not affected by it.</p>
<p><strong>Specification of the SQL</strong>: This is what you (obviously) have to do yourself. The SQL ideally uses bind parameters, to avoid any chances of SQL injection from happening. Parameters are passed to the JDBC template as arguments.</p>
<p><strong>Creation / execution of statement and iterating over result set</strong>: After you’ve specified the SQL, Spring is going to create the statement for you, set any parameters you may have specified, execute it and loop over the result set for you.</p>
<p><strong>Parse result from result set</strong>: You can opt for parsing the result set yourself if you like (or if you have complex parsing requirements), or you can have Spring result a list of primitives, or just one value from the result set.</p>
<p><strong>Handling and translation of exceptions</strong>: This is where Spring translates any exceptions that might have occurred to Spring’s own DataAccessException hierarchy, automatically insulating calling code from the data access technology in use.</p>
<p><strong>Releasing of connection</strong>: This is the last piece of the puzzle where Spring releases any resources used. Of course, if transaction synchronization is active, the resources might not be released immediately.</p>
<p>Templates are available for several APIs such as:</p>
<ul>
<li>JDBC (JdbcTemplate)</li>
<li>Hibernate (HibernateTemplate)</li>
<li>iBatis (SqlMapClientTemplate)</li>
<li>JDO (JdoTemplate)</li>
<li>TopLink (TopLinkTemplate)</li>
<li>Messaging (JmsTempate)</li>
<li>Transaction management (TransactionTemplate)</li>
<li>JNDI (JndiTemplate)</li>
</ul>
<h2 id="Are-templates-really-necessary"><a href="#Are-templates-really-necessary" class="headerlink" title="Are templates really necessary?"></a>Are templates really necessary?</h2><p>The templates add a lot of value when using an API that uses checked exceptions (as opposed to runtime exceptions or unchecked exceptions), but also add a lot of consistency to your code base. People having learnt Spring’s <code>JdbcTemplate</code> can pretty easily start using Spring’s <code>JdoTemplate</code> or Spring’s <code>HibernateTemplate</code>–the approach to using those is similar for each one of them.</p>
<p>The most visible impact of the Spring template approach is the code reduction for for example JDBC. This is primarily because the checked exceptions are translated to runtime exceptions inside the template, removing the need to catch the exception in your mainline code. Other reasons are the transparent resource management and automatic synchronization with the currently running transaction. Of course it’s fairly easy to change a framework to use runtime exceptions natively instead of Spring having to do this and this is what for example Hibernate has started to do from version 3.0 onwards. Hibernate is not the only technology to do this–the Java Persistence API is also using runtime exceptions.</p>
]]></content>
    
    <summary type="html">
    
      So should you still use Spring&#39;s HibernateTemplate and/or JpaTemplate??
    
    </summary>
    
      <category term="java" scheme="http://jishusuishouji.github.io/categories/java/"/>
    
      <category term="spring" scheme="http://jishusuishouji.github.io/categories/java/spring/"/>
    
    
      <category term="spring" scheme="http://jishusuishouji.github.io/tags/spring/"/>
    
      <category term="java" scheme="http://jishusuishouji.github.io/tags/java/"/>
    
      <category term="hibernate" scheme="http://jishusuishouji.github.io/tags/hibernate/"/>
    
      <category term="HibernateTemplate" scheme="http://jishusuishouji.github.io/tags/HibernateTemplate/"/>
    
  </entry>
  
  <entry>
    <title>java分布式事务(JTA)实现 jotm和atomikos</title>
    <link href="http://jishusuishouji.github.io/2017/01/08/java/jta/java%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1_JTA_%E5%AE%9E%E7%8E%B0%20jotm%E5%92%8Catomikos/"/>
    <id>http://jishusuishouji.github.io/2017/01/08/java/jta/java分布式事务_JTA_实现 jotm和atomikos/</id>
    <published>2017-01-08T02:03:52.000Z</published>
    <updated>2017-01-08T08:17:24.019Z</updated>
    
    <content type="html"><![CDATA[<p>本地事务：只对单一数据源(单个数据库)事务进行控制。<br>分布式事务：处理多种异构的数据源， 比如某个业务操作中同时包含JDBC和JMS或者某个操作需要访问多个不同的数据库，在不同数据库之间进行事务控制。</p>
<p>在Java中，分布式事务主要的规范是JTA/XA。其中：JTA是Java的事务管理器规范，XA是工业标准的X/Open CAE规范，可被两阶段提交及回滚的事务资源定义。比如某数据库实现了XA规范，则不管是JTA，还是MSDTC，都可以基于同样的行为对该数据库进行事务处理。</p>
<p>JTA全称为Java Transaction API，顾名思义JTA定义了一组统一的事务编程的接口，这些接口如下：</p>
<p><code>XAResource</code>：XAResource接口是对实现了X/Open CAE规范的资源管理器 (Resource Manager，数据库就是典型的资源管理器) 的抽象，它由资源适配器 (Resource Apdater) 提供实现。<code>XAResource</code>是支持事务控制的核心。<br><code>Transaction</code>：<code>Transaction</code>接口是一个事务实例的抽象，通过它可以控制事务内多个资源的提交或者回滚。二阶段提交过程也是由<code>Transaction</code>接口的实现者来完成的。<br><code>TransactionManager</code>：托管模式 (managed mode)   下，<code>TransactionManager</code>接口是被应用服务器调用，以控制事务的边界的。<br><code>UserTransaction</code>：非托管模式 (non-managed mode) 下，应用程序可以通过<code>UserTransaction</code>接口控制事务的边界</p>
<p>在tomcat下是没有分布式事务的，可以借助于第三方Jotm和Automikos实现，在spring中分布式事务是通过jta（jotm，atomikos）来进行实现。即：通过代码的方式来决定是否是分布式事务。</p>
<p>注：推荐用服务器自己的数据源(也就是 lookup JNDI)，这样的话，是不是XA事务就由服务器的配置来定制，代码就不需要任何配置来决定是不是XA了。<br>事务本身是不是XA (分布式的）是服务器的事，服务器来管理“资源” （包括数据源，JMS 连接等，一个资源（JDBC连接）如何参与事务是“资源管理器”（驱动程序）的职责，跟程序无关），服务器提供事务管理并作为“事务协调者”来处理多个“资源管理器”（不同的数据库连接）之间的事务一致性。</p>
<p>jotm和automikos网址：<br>1、<a href="http://jotm.objectweb.org/" target="_blank" rel="external">http://jotm.objectweb.org/</a><br>2、<a href="http://www.atomikos.com/Main/TransactionsEssentials" target="_blank" rel="external">http://www.atomikos.com/Main/TransactionsEssentials</a> </p>
<p>Spring 通过AOP技术可以让我们在脱离EJB的情况下享受声明式事务的丰盛大餐。此外，通过配合使用ObjectWeb的JOTM开源项目，不需要Java EE应用服务器，Spring也可以提供JTA事务。 </p>
<p>正因为AOP让Spring拥有了脱离EJB容器的声明式事务能力，而JOTM让我们在脱离Java EE应用服务器下拥有JTA事务能力。所以，人们将AOP和JOTM称为Java软件开发的两个圣杯。    </p>
<p>JTA的实现框架有：<br>GeronimoTM/Jencks  官方文档比较少，不适合学习和维护。<br>SimpleJTA 没有实现JTS (Java Transaction Service)而且不是活跃的。<br>Atomikos  是一个另人钦佩的产品。有丰富的文档，而且有很好的支持。<br>JBossTS  是一个应用在JBOSS服务器上的，肯定是一个成熟的产品，也有好的支持，详细信息可以看这里：<a href="http://www.theserverside.com/news/thread.tss?thread_id=37941" target="_blank" rel="external">http://www.theserverside.com/news/thread.tss?thread_id=37941</a><br>最常见的二个如下：<br>JOTM<br>    JOTM(Java Open Transaction Manager)是ObjectWeb的一个开源JTA实现，它本身也是开源应用程序服务器JOnAS(Java Open Application Server)的一部分，为其提供JTA分布式事务的功能。<br>    存在的问题：使用中不能自动rollback，无论什么情况都commit。注：spring3开始已经不再支持jotm</p>
<p>Atomikos<br>    大家推荐最多的。和JOTM相比Atomikos Transactions Essentials更加稳定，它原来是商业项目，现在开源了。象MySQL一样卖服务支持的。而且论坛页比较活跃，有问题很快可以解决。 </p>
]]></content>
    
    <summary type="html">
    
      java分布式事务(JTA)实现 jotm和atomikos
    
    </summary>
    
      <category term="java" scheme="http://jishusuishouji.github.io/categories/java/"/>
    
      <category term="jta" scheme="http://jishusuishouji.github.io/categories/java/jta/"/>
    
    
      <category term="java" scheme="http://jishusuishouji.github.io/tags/java/"/>
    
      <category term="jta" scheme="http://jishusuishouji.github.io/tags/jta/"/>
    
      <category term="分布式事务" scheme="http://jishusuishouji.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
      <category term="jotm" scheme="http://jishusuishouji.github.io/tags/jotm/"/>
    
      <category term="atomikos" scheme="http://jishusuishouji.github.io/tags/atomikos/"/>
    
  </entry>
  
  <entry>
    <title>java分布式事务:spring+JTA+jotm</title>
    <link href="http://jishusuishouji.github.io/2017/01/08/java/jta/java%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1_spring_JTA_jotm/"/>
    <id>http://jishusuishouji.github.io/2017/01/08/java/jta/java分布式事务_spring_JTA_jotm/</id>
    <published>2017-01-08T01:23:24.000Z</published>
    <updated>2017-01-08T08:18:52.796Z</updated>
    
    <content type="html"><![CDATA[<h2 id="业务背景"><a href="#业务背景" class="headerlink" title="业务背景"></a>业务背景</h2><p>当新建用户时需插入一条用户记录，同时还需在另一个DB中记录日志。因为是不同的DB操作，所以及到分布式事务的处理。</p>
<h3 id="1、代码结构："><a href="#1、代码结构：" class="headerlink" title="1、代码结构："></a>1、代码结构：</h3><p><img src="http://img.blog.csdn.net/20150209142444553?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGl1eGlhbzcyMzg0Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="项目在eclipse中"></p>
<h3 id="2、建表语句："><a href="#2、建表语句：" class="headerlink" title="2、建表语句："></a>2、建表语句：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">create database log;  </div><div class="line">DROP TABLE IF EXISTS `log`;  </div><div class="line">CREATE TABLE `log` (  </div><div class="line">  `id` varchar(20) NOT NULL,  </div><div class="line">  `content` varchar(100) default NULL,  </div><div class="line">  PRIMARY KEY  (`id`)  </div><div class="line">);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">create database user;  </div><div class="line">DROP TABLE IF EXISTS `user`;  </div><div class="line">CREATE TABLE `user` (  </div><div class="line">  `id` varchar(20) NOT NULL,  </div><div class="line">  `name` varchar(40) default NULL,  </div><div class="line">  PRIMARY KEY  (`id`)  </div><div class="line">);</div></pre></td></tr></table></figure>
<h3 id="3、配置文件application-xml"><a href="#3、配置文件application-xml" class="headerlink" title="3、配置文件application.xml"></a>3、配置文件<code>application.xml</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">&lt;!--?xml version=1.0 encoding=UTF-8?--&gt;  </div><div class="line">&lt;beans aop=&quot;&quot; beans=&quot;&quot; http:=&quot;&quot; schema=&quot;&quot; spring-aop.xsd=&quot;&quot; spring-beans.xsd=&quot;&quot; spring-tx.xsd=&quot;&quot; tx=&quot;&quot; www.springframework.org=&quot;&quot; xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemalocation=&quot;http://www.springframework.org/schema/beans&quot;&gt;  </div><div class="line">       </div><div class="line">    &lt;!-- 引用Spring内部所提供的对JOTM支持的工厂类 --&gt;  </div><div class="line">    &lt;bean class=&quot;org.springframework.transaction.jta.JotmFactoryBean&quot; id=&quot;jotm&quot;/&gt;  </div><div class="line">       </div><div class="line">    &lt;!-- 配置JTA事务管理器, 并在管理器中使用上面所配置的JOTM --&gt;  </div><div class="line">    &lt;bean class=&quot;org.springframework.transaction.jta.JtaTransactionManager&quot; id=&quot;txManager&quot;&gt;  </div><div class="line">        &lt;property name=&quot;userTransaction&quot; ref=&quot;jotm&quot;/&gt;</div><div class="line">    &lt;/bean&gt;  </div><div class="line">       </div><div class="line">    &lt;!-- 配置多个数据源 --&gt;  </div><div class="line">    &lt;bean class=&quot;org.enhydra.jdbc.pool.StandardXAPoolDataSource&quot; destroy-method=&quot;shutdown&quot; id=&quot;db1&quot;&gt;  </div><div class="line">        &lt;property name=&quot;dataSource&quot;&gt;  </div><div class="line">            &lt;bean class=&quot;org.enhydra.jdbc.standard.StandardXADataSource&quot; destroy-method=&quot;shutdown&quot;&gt;  </div><div class="line">                &lt;property name=&quot;transactionManager&quot; ref=&quot;jotm&quot;/&gt;  </div><div class="line">                &lt;property name=&quot;driverName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;  </div><div class="line">                &lt;property name=&quot;url&quot; value=&quot;jdbc:MySQL://localhost:3306/user&quot;/&gt;  </div><div class="line">            &lt;/bean&gt;  </div><div class="line">        &lt;/property&gt;  </div><div class="line">        &lt;property name=&quot;user&quot; value=&quot;root&quot;/&gt;  </div><div class="line">        &lt;property name=&quot;password&quot; value=&quot;root&quot;/&gt;  </div><div class="line">    &lt;/bean&gt;  </div><div class="line">   </div><div class="line">    &lt;bean class=&quot;org.enhydra.jdbc.pool.StandardXAPoolDataSource&quot; destroy-method=&quot;shutdown&quot; id=&quot;db2&quot;&gt;  </div><div class="line">        &lt;property name=&quot;dataSource&quot;&gt;  </div><div class="line">            &lt;bean class=&quot;org.enhydra.jdbc.standard.StandardXADataSource&quot; destroy-method=&quot;shutdown&quot;&gt;  </div><div class="line">                &lt;property name=&quot;transactionManager&quot; ref=&quot;jotm&quot;/&gt;  </div><div class="line">                &lt;property name=&quot;driverName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;  </div><div class="line">                &lt;property name=&quot;url&quot; value=&quot;jdbc:MySQL://localhost:3306/log&quot;/&gt;  </div><div class="line">            &lt;/bean&gt;  </div><div class="line">        &lt;/property&gt;  </div><div class="line">        &lt;property name=&quot;user&quot; value=&quot;root&quot;/&gt;  </div><div class="line">        &lt;property name=&quot;password&quot; value=&quot;root&quot;/&gt;  </div><div class="line">    &lt;/bean&gt;  </div><div class="line">       </div><div class="line">    &lt;!-- 根据不同的数据源配置两个jdbcTemplate --&gt;  </div><div class="line">    &lt;bean class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot; id=&quot;jdbcTemplate1&quot;&gt;  </div><div class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;db1&quot;/&gt;  </div><div class="line">    &lt;/bean&gt;  </div><div class="line">   </div><div class="line">    &lt;bean class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot; id=&quot;jdbcTemplate2&quot;&gt;  </div><div class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;db2&quot;/&gt;  </div><div class="line">    &lt;/bean&gt;  </div><div class="line">   </div><div class="line">    &lt;bean class=&quot;com.zdp.dao.UserDao&quot; id=&quot;userDao&quot;&gt;  </div><div class="line">        &lt;property name=&quot;jdbcTemplate&quot; ref=&quot;jdbcTemplate1&quot;/&gt;  </div><div class="line">    &lt;/bean&gt;  </div><div class="line">   </div><div class="line">    &lt;bean class=&quot;com.zdp.dao.LogDao&quot; id=&quot;logDao&quot;&gt;  </div><div class="line">        &lt;property name=&quot;jdbcTemplate&quot; ref=&quot;jdbcTemplate2&quot;/&gt;  </div><div class="line">    &lt;/bean&gt;  </div><div class="line">   </div><div class="line">    &lt;bean class=&quot;com.zdp.service.UserService&quot; id=&quot;userService&quot;/&gt;  </div><div class="line">        &lt;property name=&quot;userDao&quot; ref=&quot;userDao&quot;/&gt;  </div><div class="line">        &lt;property name=&quot;logDao&quot; ref=&quot;logDao&quot;/&gt;  </div><div class="line">    &lt;/bean&gt;  </div><div class="line">       </div><div class="line">    &lt;!-- JTA事务传播特性 --&gt;  </div><div class="line">    &lt;tx:advice id=&quot;txAdviceJTA&quot; transaction-manager=&quot;txManager&quot;&gt;  </div><div class="line">        &lt;tx:attributes&gt;  </div><div class="line">            &lt;tx:method isolation=&quot;DEFAULT&quot; name=&quot;save*&quot; propagation=&quot;REQUIRED&quot; rollback-for=&quot;Exception/&quot;&gt;  </div><div class="line">            &lt;tx:method isolation=&quot;DEFAULT&quot; name=&quot;add*&quot; propagation=&quot;REQUIRED&quot; rollback-for=&quot;Exception/&quot;&gt;  </div><div class="line">            &lt;tx:method isolation=&quot;DEFAULT&quot; name=&quot;create*&quot; propagation=&quot;REQUIRED&quot; rollback-for=&quot;Exception/&quot;&gt;  </div><div class="line">            &lt;tx:method isolation=&quot;DEFAULT&quot; name=&quot;insert*&quot; propagation=&quot;REQUIRED&quot; rollback-for=&quot;Exception/&quot;&gt;  </div><div class="line">            &lt;tx:method isolation=&quot;DEFAULT&quot; name=&quot;del*&quot; propagation=&quot;REQUIRED&quot; rollback-for=&quot;Exception/&quot;&gt;  </div><div class="line">            &lt;tx:method isolation=&quot;DEFAULT&quot; name=&quot;update*&quot; propagation=&quot;REQUIRED&quot; rollback-for=&quot;Exception/&quot;&gt;  </div><div class="line">            &lt;tx:method name=&quot;*&quot; read-only=&quot;true/&quot;&gt;   </div><div class="line">        &lt;/tx:attributes&gt;  </div><div class="line">    &lt;/tx:advice&gt;  </div><div class="line">            </div><div class="line">           </div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
<h3 id="4、service业务类："><a href="#4、service业务类：" class="headerlink" title="4、service业务类："></a>4、service业务类：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">public class UserService &#123;  </div><div class="line">    private UserDao userDao;  </div><div class="line">    private LogDao logDao;  </div><div class="line">   </div><div class="line">    public void saveUser(String id, String name) &#123;  </div><div class="line">        userDao.insertUser(id, name);  </div><div class="line">        // int i = 1 / 0;  // 制造异常  </div><div class="line">        logDao.insertLog(id, id + _ + name);  </div><div class="line">    &#125;  </div><div class="line">   </div><div class="line">    public UserDao getUserDao() &#123;  </div><div class="line">        return userDao;  </div><div class="line">    &#125;  </div><div class="line">   </div><div class="line">    public void setUserDao(UserDao userDao) &#123;  </div><div class="line">        this.userDao = userDao;  </div><div class="line">    &#125;  </div><div class="line">   </div><div class="line">    public LogDao getLogDao() &#123;  </div><div class="line">        return logDao;  </div><div class="line">    &#125;  </div><div class="line">   </div><div class="line">    public void setLogDao(LogDao logDao) &#123;  </div><div class="line">        this.logDao = logDao;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5、dao类："><a href="#5、dao类：" class="headerlink" title="5、dao类："></a>5、dao类：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public class UserDao extends JdbcDaoSupport &#123;  </div><div class="line">    public void insertUser(String id, String name) &#123;  </div><div class="line">        JdbcTemplate template = getJdbcTemplate();  </div><div class="line">        template.execute(insert into user values(&apos; + id + &apos;,&apos; + name + &apos;));  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public class LogDao extends JdbcDaoSupport &#123;  </div><div class="line">    public void insertLog(String id, String content) &#123;  </div><div class="line">        JdbcTemplate template = getJdbcTemplate();  </div><div class="line">        template.execute(insert into log values(&apos; + id + &apos;,&apos; + content + &apos;));  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6、测试类："><a href="#6、测试类：" class="headerlink" title="6、测试类："></a>6、测试类：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class UserTest &#123;  </div><div class="line">    @Test  </div><div class="line">    public void testSave() &#123;  </div><div class="line">        ApplicationContext cxt = new ClassPathXmlApplicationContext(ApplicationContext.xml);  </div><div class="line">        UserService us = (UserService) cxt.getBean(userService);  </div><div class="line">        us.saveUser(1, zhangsan);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      java分布式事务:spring+JTA+jotm
    
    </summary>
    
      <category term="java" scheme="http://jishusuishouji.github.io/categories/java/"/>
    
    
      <category term="spring" scheme="http://jishusuishouji.github.io/tags/spring/"/>
    
      <category term="java" scheme="http://jishusuishouji.github.io/tags/java/"/>
    
      <category term="jta" scheme="http://jishusuishouji.github.io/tags/jta/"/>
    
      <category term="jotm" scheme="http://jishusuishouji.github.io/tags/jotm/"/>
    
  </entry>
  
</feed>
